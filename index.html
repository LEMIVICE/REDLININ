<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDLININ' RACING HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for the "Digital Redline" Aesthetic */
        body {
            background-color: #000000;
            color: #EFEFEF;
            font-family: 'Roboto Condensed', sans-serif;
            overflow: hidden;
            cursor: none;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .hidden {
            display: none !important;
        }

        .opacity-0 {
            opacity: 0;
        }

        .transition-opacity {
            transition: opacity 0.5s ease-in-out;
        }

        .transition-transform {
            transition: transform 0.5s ease-in-out;
        }
        
        /* HUD Bar */
        #hud-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #FF2D00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 200;
            font-family: 'Orbitron', sans-serif;
        }

        #hud-left {
            display: flex;
            align-items: center;
        }

        #hud-logo {
            height: 20px;
            margin-right: 15px;
        }
        
        #hud-location {
            color: #EFEFEF;
        }

        #hud-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #audio-visualizer {
            height: 40px;
        }

        #hud-right {
             color: #EFEFEF;
        }


        /* Boot Sequence Styling */
        #boot-sequence .boot-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        #lv-emblem-screen img {
            width: 80px;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        #publisher-screen .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: #40E0D0;
            text-shadow: 0 0 5px #40E0D0;
            animation: fadeInOut 3s forwards;
        }
        
        /* Main Title Screen */
        #title-screen {
            background-image: url('assets/start_menu_bg.png');
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #redlinin-logo {
            position: absolute;
            width: 40%;
            max-width: 500px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(5);
            opacity: 0;
        }
        
        #press-start {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #EFEFEF;
            text-shadow: 0 0 10px #FF2D00;
            animation: blink 1s infinite;
        }

        @keyframes slam-in {
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Loading Screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 100;
        }

        #loading-icon {
            position: absolute;
            width: 100px;
            height: 100px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-image: url('assets/gold_wheel_icon.png');
            background-size: contain;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        #loading-text {
            position: absolute;
            top: calc(50% + 70px);
            left: 50%;
            transform: translateX(-50%);
            color: #EFEFEF;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
        }

        /* HQ Lobby Styling */
        #hq-lobby {
            background-size: cover;
            background-position: center;
            position: relative;
            width: 100vw;
            height: 100vh;
            padding-top: 50px; /* Account for HUD */
        }

        .hotspot {
            position: absolute;
            background-color: rgba(255, 45, 0, 0);
            border: 2px solid rgba(64, 224, 208, 0);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 0 0px #40E0D0;
            cursor: none;
        }

        .hotspot:hover {
            background-color: rgba(255, 45, 0, 0.3);
            border: 2px solid #40E0D0;
            box-shadow: 0 0 20px #40E0D0;
        }

        .hotspot-label {
            position: absolute;
            top: 50%;
            left: 110%;
            transform: translateY(-50%);
            white-space: nowrap;
            background-color: #000;
            padding: 5px 10px;
            border-left: 3px solid #FF2D00;
            color: #EFEFEF;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .hotspot:hover .hotspot-label {
            opacity: 1;
        }

        /* Lobby Navigation */
        .lobby-nav {
            position: absolute;
        }
        #lobby-nav-1-to-2 {
            border: 2px solid #40E0D0;
            animation: pulse-cyan 2s infinite;
        }
        @keyframes pulse-cyan {
            0% { box-shadow: 0 0 5px #40E0D0; }
            50% { box-shadow: 0 0 25px #40E0D0; }
            100% { box-shadow: 0 0 5px #40E0D0; }
        }
        
        /* Department View */
        #department-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            padding-top: 50px; /* Account for HUD */
        }
        
        #department-header {
             position: absolute;
             top: 10%;
             left: 50%;
             transform: translateX(-50%);
             font-family: 'Orbitron', sans-serif;
             font-size: 2rem;
             color: #EFEFEF;
             background-color: rgba(0,0,0,0.7);
             padding: 10px 30px;
             border-top: 2px solid #FF2D00;
             border-bottom: 2px solid #FF2D00;
        }
        
        .department-button {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: #EFEFEF;
            background-color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: none;
            transition: all 0.3s ease;
        }
        
        #back-button {
            border: 2px solid #40E0D0;
        }
        #back-button:hover {
            background-color: #40E0D0;
            color: #000;
            box-shadow: 0 0 15px #40E0D0;
        }
        #return-to-bay-button {
             border: 2px solid #FF2D00;
        }
        #return-to-bay-button:hover {
            background-color: #FF2D00;
            color: #000;
        }
        
        /* Custom Cursor */
        #cursor-dot {
            width: 8px;
            height: 8px;
            background-color: #40E0D0;
            border-radius: 50%;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 0 5px #40E0D0;
            transition: transform 0.1s ease-out;
        }
        
        #cursor-ring {
            width: 30px;
            height: 30px;
            border: 2px solid #EFEFEF;
            border-radius: 50%;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        
        body:hover #cursor-ring {
            opacity: 1;
        }
        
        /* Main Menu */
        #main-menu {
            background-image: url('assets/main_menu_bg.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 2rem;
        }

        .menu-option {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: #EFEFEF;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            cursor: none;
            transition: all 0.3s ease;
            padding: 10px 20px;
            border: 2px solid transparent;
        }
        
        .menu-option.selected {
            color: #FF2D00;
            text-shadow: 0 0 15px #FF2D00;
            border: 2px solid #FF2D00;
        }

        /* News Ticker */
        #news-ticker-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #FF2D00;
            height: 40px;
            overflow: hidden;
        }

        #news-ticker {
            display: flex;
            align-items: center;
            height: 100%;
            white-space: nowrap;
            animation: marquee 60s linear infinite;
        }

        #news-ticker p {
            padding: 0 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: #EFEFEF;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* MP3 Player */
        #mp3-player {
            position: absolute;
            bottom: 60px; /* Above the ticker */
            right: 20px;
            width: 300px;
            background-color: #111;
            border: 2px solid #40E0D0;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.3);
            font-family: 'Orbitron', sans-serif;
            user-select: none;
            z-index: 50;
        }

        #mp3-header {
            background-color: #222;
            padding: 5px 10px;
            cursor: move;
            border-bottom: 2px solid #40E0D0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #mp3-header img {
            height: 15px;
        }

        #mp3-body {
            padding: 15px;
        }
        
        #track-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #album-art {
            width: 60px;
            height: 60px;
            margin-right: 10px;
            border: 1px solid #40E0D0;
        }

        #track-display {
            color: #EFEFEF;
            text-align: center;
            background-color: #000;
            padding: 5px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            overflow: hidden;
            white-space: nowrap;
        }

        .slider-container {
            margin-bottom: 10px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #000;
            border: 1px solid #40E0D0;
            outline: none;
            cursor: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #FF2D00;
            cursor: none;
            border: 1px solid #EFEFEF;
        }

        #controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        #controls button {
            background: none;
            border: none;
            color: #EFEFEF;
            font-size: 1.2rem;
            cursor: none;
            transition: color 0.2s ease;
        }

        #controls button:hover {
            color: #FF2D00;
        }
        
        /* Boiler Room & Puzzles */
        .glitch-artifact {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #FF2D00;
            cursor: none;
            z-index: 60;
            animation: glitch-anim 1.5s infinite steps(8);
        }

        @keyframes glitch-anim {
            0% { transform: translate(0, 0); opacity: 0.8; }
            10% { transform: translate(-5px, 5px); }
            20% { transform: translate(5px, -5px); }
            30% { transform: translate(-5px, -5px); }
            40% { transform: translate(5px, 5px); }
            50% { opacity: 0.5; clip-path: inset(50% 0 0 0); }
            60% { clip-path: inset(0 50% 50% 0); }
            70% { clip-path: inset(25% 25% 25% 25%); }
            80% { opacity: 1; }
            90% { transform: skew(10deg, 10deg); }
            100% { transform: translate(0, 0); opacity: 0.8; }
        }

        #boiler-room-hotspot {
            bottom: 2%;
            left: 2%;
            width: 100px;
            height: 50px;
            border-radius: 5px;
            background-color: rgba(100, 100, 100, 0.5);
            border: 2px solid #555;
            transform: perspective(100px) rotateX(45deg);
        }

        #notification {
            position: absolute;
            top: 60px; /* Below HUD */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: #40E0D0;
            padding: 15px 25px;
            border: 2px solid #40E0D0;
            border-radius: 5px;
            z-index: 200;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            text-shadow: 0 0 5px #40E0D0;
        }
        
        #boiler-room {
            background-image: url('assets/boiler_room_bg.png');
        }

        /* Hacking Console */
        #hacking-console-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }
        
        #console-window {
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background-image: url('assets/led_console.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            padding: 8% 10%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #console-output {
            flex-grow: 1;
            background-color: rgba(0, 20, 0, 0.8);
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #00FF00;
        }
        
        #console-input-line {
            display: flex;
            padding-top: 10px;
        }

        #console-input-line span {
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
        }
        
        #console-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
            outline: none;
        }
        
        #close-console {
            position: absolute;
            top: 12%;
            right: 17%;
            color: #FF2D00;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: none;
        }
        
        /* DATALAB Navigation */
        .datalab-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            border: 2px solid #40E0D0;
            color: #40E0D0;
            padding: 20px 10px;
            font-size: 2rem;
            cursor: none;
            z-index: 160;
            transition: all 0.2s ease;
        }
        .datalab-nav:hover {
             background-color: #40E0D0;
             color: #000;
        }
        #datalab-nav-left { left: 2%; }
        #datalab-nav-right { right: 2%; }

        #access-terminal-button {
             position: absolute;
             bottom: 12%;
             left: 50%;
             transform: translateX(-50%);
             font-family: 'Orbitron', sans-serif;
             font-size: 1.2rem;
             color: #EFEFEF;
             background-color: #000;
             padding: 10px 20px;
             border: 2px solid #FF2D00;
             border-radius: 5px;
             cursor: none;
             transition: all 0.3s ease;
        }
        #access-terminal-button:hover {
            background-color: #FF2D00;
            color: #000;
            box-shadow: 0 0 15px #FF2D00;
        }
        
        /* Fix for console showing up uninvited */
        #hacking-console-container.hidden {
            display: none !important;
        }

    </style>
</head>

<body>

    <!-- HUD Bar -->
    <div id="hud-bar" class="hidden">
        <div id="hud-left">
            <img id="hud-logo" src="assets/redlinin_logo.png" alt="Redlinin Logo">
            <span id="hud-location"></span>
        </div>
        <div id="hud-center">
            <canvas id="audio-visualizer" width="300" height="40"></canvas>
        </div>
        <div id="hud-right">
            <span id="hud-clock"></span>
        </div>
    </div>


    <!-- Custom Cursor -->
    <div id="cursor-dot"></div>
    <div id="cursor-ring"></div>

    <!-- Boot Sequence -->
    <div id="boot-sequence">
        <div id="lv-emblem-screen" class="boot-screen">
             <img src="assets/lemi_vice_logo.png" alt="Lemi Vice Emblem">
        </div>
        <div id="publisher-screen" class="boot-screen hidden">
            <h2 class="logo">REDLININ' Interactive</h2>
        </div>
    </div>

    <!-- Main Title Screen -->
    <div id="title-screen" class="hidden">
        <img id="redlinin-logo" src="assets/redlinin_logo.png" alt="Redlinin Logo">
        <h1 id="press-start" class="hidden">PRESS START</h1>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="hidden" style="width: 100vw; height: 100vh;">
         <div id="menu-option-new-game" class="menu-option selected">NEW GAME</div>
         <div id="menu-option-settings" class="menu-option">SETTINGS</div>
    </div>


    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden">
        <div id="loading-icon"></div>
        <p id="loading-text">NOW LOADING</p>
    </div>

    <!-- Main HQ Hub -->
    <div id="hq-lobby" class="hidden">
        <!-- Department Hotspots -->
        <div class="department-hotspot hotspot" style="top: 45%; left: 15%; width: 200px; height: 200px;" data-target="garage">
            <div class="hotspot-label">THE GARAGE</div>
        </div>
        <div class="department-hotspot hotspot" style="top: 40%; left: 45%; width: 150px; height: 150px;" data-target="datalab">
            <div class="hotspot-label">THE DATALAB</div>
        </div>
        <div class="department-hotspot hotspot" style="top: 25%; left: 60%; width: 100px; height: 250px;" data-target="lounge">
            <div class="hotspot-label">THE LIQUID LOUNGE</div>
        </div>
        <div class="department-hotspot hotspot" style="top: 55%; left: 88%; width: 80px; height: 120px;" data-target="rally">
            <div class="hotspot-label">THE RALLY DIVISION</div>
        </div>
        <div class="department-hotspot hotspot" style="top: 65%; left: 70%; width: 180px; height: 100px;" data-target="ql-sim">
            <div class="hotspot-label">QL SIMULATOR</div>
        </div>
        
        <!-- Boiler Room Puzzle Trigger -->
        <div id="boiler-room-hotspot" class="hotspot hidden" data-target="boiler-room">
             <div class="hotspot-label">ACCESS GRATE</div>
        </div>

        <!-- Lobby Navigation Hotspots -->
        <div id="lobby-nav-1-to-2" class="lobby-nav hotspot" style="top: 40%; left: 47%; width: 120px; height: 120px; border-radius: 50%;">
            <div class="hotspot-label" style="top: -30px; left: 50%; transform: translateX(-50%);">NEXT AREA</div>
        </div>
         <div id="lobby-nav-2-to-1" class="lobby-nav hotspot" style="top: 20%; left: 5%; width: 15%; height: 60%;">
            <div class="hotspot-label">PREVIOUS AREA</div>
        </div>
        <div id="lobby-nav-2-to-3" class="lobby-nav hotspot" style="top: 25%; left: 55%; width: 25%; height: 50%;">
            <div class="hotspot-label">UPPER LEVEL</div>
        </div>
        <div id="lobby-nav-3-to-2" class="lobby-nav hotspot" style="top: 40%; left: 5%; width: 100px; height: 250px; border-radius: 10px;">
            <div class="hotspot-label">LOWER LEVEL</div>
        </div>
        
        <!-- News Ticker -->
        <div id="news-ticker-container">
            <div id="news-ticker"><p></p></div>
        </div>

        <!-- MP3 Player -->
        <div id="mp3-player">
            <div id="mp3-header">
                <img src="assets/redlinin_logo.png" alt="Redlinin">
                <span>SSM Player</span>
            </div>
            <div id="mp3-body">
                 <div id="track-info">
                     <img id="album-art" src="assets/REDLININ_HQ_MENU_MUSIC__ART_1080_v1.png" alt="Album Art">
                     <div style="flex-grow: 1;">
                        <div id="track-display">NOT PLAYING</div>
                        <div id="time-display" style="text-align:center; font-size: 0.8rem; color: #aaa;">0:00 / 0:00</div>
                     </div>
                 </div>

                <div class="slider-container">
                    <input type="range" id="seek-slider" min="0" max="100" value="0">
                </div>
                <div class="slider-container" style="display: flex; align-items: center; gap: 5px;">
                    <span>VOL</span>
                    <input type="range" id="volume-slider" min="0" max="100" value="50">
                </div>
                <div id="controls">
                    <button id="prev-btn">⏮</button>
                    <button id="play-pause-btn">▶</button>
                    <button id="next-btn">⏭</button>
                </div>
            </div>
             <!-- Puzzle 3 -->
            <div id="puzzle-3" class="glitch-artifact" style="top: 5px; right: 5px; width:15px; height:15px;"></div>
        </div>

    </div>

    <!-- Department View -->
    <div id="department-view" class="hidden">
        <h2 id="department-header">DEPARTMENT</h2>
        <button id="back-button" class="department-button">RETURN TO HQ</button>
        <!-- Puzzle 2 Placeholder -->
        <div id="puzzle-2" class="glitch-artifact hidden" style="top: 80%; left: 10%;"></div>
        <!-- DATALAB UI -->
        <button id="datalab-nav-left" class="datalab-nav hidden">&lt;</button>
        <button id="datalab-nav-right" class="datalab-nav hidden">&gt;</button>
        <button id="access-terminal-button" class="hidden">ACCESS TERMINAL</button>
        <!-- Garage UI -->
        <div id="garage-nav-door" class="hotspot hidden" style="top: 35%; left: 2%; width: 12%; height: 50%; border-radius: 10px;">
             <div class="hotspot-label">SECONDARY BAY</div>
        </div>
        <button id="return-to-bay-button" class="department-button hidden">RETURN TO MAIN BAY</button>
    </div>

    <!-- Hacking Console -->
    <div id="hacking-console-container" class="hidden">
        <div id="console-window">
             <div id="console-output"></div>
             <div id="console-input-line">
                 <span>>&nbsp;</span>
                 <input type="text" id="console-input" autofocus>
             </div>
        </div>
        <button id="close-console">X</button>
    </div>


    <!-- Notification Area -->
    <div id="notification" class="hidden"></div>
    
    <!-- Glitch Artifact for Main Menu -->
    <div id="puzzle-1" class="glitch-artifact hidden" style="bottom: 5%; right: 5%;"></div>


    <audio id="boiler-room-audio" loop>
        <source src="assets/sfx/boiler_room_ambience.wav" type="audio/wav">
    </audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bootSeq = document.getElementById('boot-sequence');
            const lvScreen = document.getElementById('lv-emblem-screen');
            const pubScreen = document.getElementById('publisher-screen');
            const titleScreen = document.getElementById('title-screen');
            const redlininLogo = document.getElementById('redlinin-logo');
            const pressStart = document.getElementById('press-start');
            const loadingScreen = document.getElementById('loading-screen');
            const hqLobby = document.getElementById('hq-lobby');
            const departmentView = document.getElementById('department-view');
            const departmentHeader = document.getElementById('department-header');
            const backButton = document.getElementById('back-button');
            const mainMenu = document.getElementById('main-menu');
            const menuOptionNewGame = document.getElementById('menu-option-new-game');
            const menuOptionSettings = document.getElementById('menu-option-settings');

            // HUD Elements
            const hudBar = document.getElementById('hud-bar');
            const hudLocation = document.getElementById('hud-location');
            const hudClock = document.getElementById('hud-clock');
            const visualizerCanvas = document.getElementById('audio-visualizer');
            const visualizerCtx = visualizerCanvas.getContext('2d');

            // Custom Cursor
            const cursorDot = document.getElementById('cursor-dot');
            const cursorRing = document.getElementById('cursor-ring');

            window.addEventListener('mousemove', e => {
                cursorDot.style.left = e.clientX + 'px';
                cursorDot.style.top = e.clientY + 'px';
                cursorRing.style.left = (e.clientX - 13) + 'px';
                cursorRing.style.top = (e.clientY - 13) + 'px';
            });
            
            document.body.addEventListener('mousedown', () => cursorDot.style.transform = 'scale(2)');
            document.body.addEventListener('mouseup', () => cursorDot.style.transform = 'scale(1)');


            // --- Game State ---
            let currentState = 'boot';
            let currentMenuSelection = 0;
            const menuOptions = ['new-game', 'settings'];
            
            // --- Puzzle State ---
            const puzzleState = {
                puzzle1: false,
                puzzle2: false,
                puzzle3: false,
            };
            
            const puzzles = {
                'puzzle-1': document.getElementById('puzzle-1'),
                'puzzle-2': document.getElementById('puzzle-2'),
                'puzzle-3': document.getElementById('puzzle-3'),
            };

            const boilerRoomHotspot = document.getElementById('boiler-room-hotspot');
            const boilerRoomAudio = document.getElementById('boiler-room-audio');
            
            // --- Lobby State ---
            let currentLobbyRoom = 0;
            const lobbyBackgrounds = [
                'assets/hq_lobby_bg.png',
                'assets/hq_lobby2_bg.png',
                'assets/hq_lobby3_bg.png'
            ];
            const departmentHotspots = document.querySelectorAll('.department-hotspot');
            const lobbyNavHotspots = {
                '1-2': document.getElementById('lobby-nav-1-to-2'),
                '2-1': document.getElementById('lobby-nav-2-to-1'),
                '2-3': document.getElementById('lobby-nav-2-to-3'),
                '3-2': document.getElementById('lobby-nav-3-to-2'),
            };

            // --- DATALAB State ---
            let currentDatalabRoom = 0;
            const datalabBackgrounds = [
                'assets/datalab1.png',
                'assets/datalab2.png',
                'assets/datalab3.png'
            ];
            const datalabNavLeft = document.getElementById('datalab-nav-left');
            const datalabNavRight = document.getElementById('datalab-nav-right');
            const accessTerminalButton = document.getElementById('access-terminal-button');
            
            // --- GARAGE State ---
            let currentGarageRoom = 0;
            const garageBackgrounds = [
                 'assets/garage_bg1.png',
                 'assets/garage_bg2.png',
            ];
            const garageNavDoor = document.getElementById('garage-nav-door');
            const returnToBayButton = document.getElementById('return-to-bay-button');

            // --- Hacking Console State ---
            const hackingConsoleContainer = document.getElementById('hacking-console-container');
            const consoleOutput = document.getElementById('console-output');
            const consoleInput = document.getElementById('console-input');
            const closeConsoleBtn = document.getElementById('close-console');

            // --- MP3 Player State & Elements ---
            const mp3Player = document.getElementById('mp3-player');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let audioSource;
            let gainNode; 
            let analyser; // For visualizer
            let audioBuffer;
            let isPlaying = false;
            let currentTrackIndex = 0;
            let isDragging = false;
            let offsetX, offsetY;
            
            let audioStartTime = 0;
            let startOffset = 0;
            let animationFrameId;
            let isMusicInitialized = false;

            const playlist = [
                { title: 'Apricot Hill Raceway', file: 'assets/music/Apricot Hill Raceway.mp3' },
                { title: 'Autumn Ring', file: 'assets/music/Autumn Ring.mp3' },
                { title: 'Complex String', file: 'assets/music/Complex String.mp3' },
                { title: 'Deep Forest Raceway', file: 'assets/music/Deep Forest Raceway.mp3' },
                { title: 'Grand Valley Speedway', file: 'assets/music/Grand Valley Speedway.mp3' },
                { title: 'Grindelwald', file: 'assets/music/Grindelwald.mp3' },
                { title: 'High Speed Ring', file: 'assets/music/High Speed Ring.mp3' },
                { title: 'Mid-Field Raceway', file: 'assets/music/Mid-Field Raceway.mp3' },
                { title: 'Red Rock Valley Speedway', file: 'assets/music/Red Rock Valley Speedway.mp3' },
                { title: 'Special Stage Route 5', file: 'assets/music/Special Stage Route 5.mp3' },
                { title: 'Special Stage Route 11', file: 'assets/music/Special Stage Route 11.mp3' },
                { title: 'Tahiti Road', file: 'assets/music/Tahiti Road.mp3' },
                { title: 'Trail Mountain', file: 'assets/music/Trail Mountain.mp3' },
            ];

            const playPauseBtn = document.getElementById('play-pause-btn');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const seekSlider = document.getElementById('seek-slider');
            const volumeSlider = document.getElementById('volume-slider');
            const trackDisplay = document.getElementById('track-display');
            const timeDisplay = document.getElementById('time-display');

            // --- Core Functions ---
            
            const transition = (targetState) => {
                loadingScreen.classList.remove('hidden');
                currentState = 'loading';
                
                // Stop any department-specific audio
                boilerRoomAudio.pause();
                boilerRoomAudio.currentTime = 0;

                setTimeout(() => {
                    // Hide all major screens
                    [titleScreen, hqLobby, departmentView, mainMenu].forEach(el => el.classList.add('hidden'));
                    
                    // Hide department-specific UI
                    puzzles['puzzle-2'].classList.add('hidden');
                    datalabNavLeft.classList.add('hidden');
                    datalabNavRight.classList.add('hidden');
                    accessTerminalButton.classList.add('hidden');
                    garageNavDoor.classList.add('hidden');
                    returnToBayButton.classList.add('hidden');
                    
                    let locationText = '';
                    let showHud = false;

                    if (targetState === 'hq-lobby') {
                        showHud = true;
                        hqLobby.classList.remove('hidden');
                        currentState = 'hq-lobby';
                        locationText = 'LOCATION: HQ LOBBY';
                        setupLobbyRoom(currentLobbyRoom);
                        if(isMusicInitialized && !isPlaying) {
                            playTrack();
                        }

                    } else if (targetState.startsWith('department-')) {
                        showHud = true;
                        departmentView.classList.remove('hidden');
                        currentState = 'department';
                        const department = targetState.split('-')[1];
                        const departmentName = `THE ${department.toUpperCase().replace('QLSIM', 'QL SIMULATOR')}`;
                        departmentHeader.textContent = departmentName;
                        locationText = `DEPT: ${departmentName}`;
                        
                        if (isPlaying) {
                            pauseTrack();
                        }
                        
                        // Department Specific Setup
                        if (department === 'datalab') {
                            currentDatalabRoom = 0;
                            setupDatalabRoom(currentDatalabRoom);
                        } else if (department === 'garage') {
                            currentGarageRoom = 0;
                            setupGarageRoom(currentGarageRoom);
                        } else if (department === 'boiler-room') {
                            boilerRoomAudio.play();
                            departmentView.style.backgroundImage = "url('assets/boiler_room_bg.png')";
                        } else {
                            departmentView.style.backgroundImage = "none";
                            departmentView.style.backgroundColor = "#111";
                        }


                    } else if (targetState === 'main-menu') {
                        mainMenu.classList.remove('hidden');
                        puzzles['puzzle-1'].classList.remove('hidden');
                        currentState = 'main-menu';
                        updateMenuSelection();
                    } 
                    
                    if (showHud) {
                        hudBar.classList.remove('hidden');
                        hudLocation.textContent = locationText;
                    } else {
                        hudBar.classList.add('hidden');
                    }

                    loadingScreen.classList.add('hidden');
                }, 1500);
            };
            
            const showNotification = (text) => {
                 const notification = document.getElementById('notification');
                 notification.textContent = text;
                 notification.classList.remove('hidden');
                 setTimeout(() => {
                     notification.classList.add('hidden');
                 }, 3000);
            };

            const checkPuzzlesSolved = () => {
                if (puzzleState.puzzle1 && puzzleState.puzzle2 && puzzleState.puzzle3) {
                    showNotification('SECURITY GRATE UNLOCKED IN HQ LOBBY');
                    boilerRoomHotspot.classList.remove('hidden');
                }
            };
            
            // --- Puzzle Logic ---
            Object.keys(puzzles).forEach(key => {
                puzzles[key].addEventListener('click', () => {
                    const puzzleNum = key.split('-')[1];
                    if (!puzzleState[key]) {
                        puzzleState[key] = true;
                        puzzles[key].classList.add('hidden');
                        showNotification(`ARTIFACT FRAGMENT ${puzzleNum}/3 COLLECTED`);
                        checkPuzzlesSolved();
                    }
                });
            });

            // --- Lobby Logic ---
            function setupLobbyRoom(roomIndex) {
                hqLobby.style.backgroundImage = `url(${lobbyBackgrounds[roomIndex]})`;
                // Hide all nav hotspots first
                Object.values(lobbyNavHotspots).forEach(el => el.classList.add('hidden'));

                if (roomIndex === 0) {
                    departmentHotspots.forEach(el => el.classList.remove('hidden'));
                    lobbyNavHotspots['1-2'].classList.remove('hidden');
                } else {
                    departmentHotspots.forEach(el => el.classList.add('hidden'));
                    if (roomIndex === 1) {
                        lobbyNavHotspots['2-1'].classList.remove('hidden');
                        lobbyNavHotspots['2-3'].classList.remove('hidden');
                    } else if (roomIndex === 2) {
                        lobbyNavHotspots['3-2'].classList.remove('hidden');
                    }
                }
            }
            
            lobbyNavHotspots['1-2'].addEventListener('click', () => { currentLobbyRoom = 1; setupLobbyRoom(1); });
            lobbyNavHotspots['2-1'].addEventListener('click', () => { currentLobbyRoom = 0; setupLobbyRoom(0); });
            lobbyNavHotspots['2-3'].addEventListener('click', () => { currentLobbyRoom = 2; setupLobbyRoom(2); });
            lobbyNavHotspots['3-2'].addEventListener('click', () => { currentLobbyRoom = 1; setupLobbyRoom(1); });

            
            // --- DATALAB Logic ---
            function setupDatalabRoom(roomIndex) {
                 departmentView.style.backgroundImage = `url(${datalabBackgrounds[roomIndex]})`;
                 datalabNavLeft.classList.remove('hidden');
                 datalabNavRight.classList.remove('hidden');

                 if (roomIndex === 1) {
                     if (!puzzleState['puzzle-2']) {
                         puzzles['puzzle-2'].classList.remove('hidden');
                     }
                     accessTerminalButton.classList.remove('hidden');
                 } else {
                     puzzles['puzzle-2'].classList.add('hidden');
                     accessTerminalButton.classList.add('hidden');
                 }
            }
            
            datalabNavLeft.addEventListener('click', () => {
                currentDatalabRoom = (currentDatalabRoom - 1 + datalabBackgrounds.length) % datalabBackgrounds.length;
                setupDatalabRoom(currentDatalabRoom);
            });
            
            datalabNavRight.addEventListener('click', () => {
                currentDatalabRoom = (currentDatalabRoom + 1) % datalabBackgrounds.length;
                setupDatalabRoom(currentDatalabRoom);
            });

            // --- Garage Logic ---
            function setupGarageRoom(roomIndex) {
                 departmentView.style.backgroundImage = `url(${garageBackgrounds[roomIndex]})`;
                 if(roomIndex === 0) {
                     garageNavDoor.classList.remove('hidden');
                     returnToBayButton.classList.add('hidden');
                 } else {
                     garageNavDoor.classList.add('hidden');
                     returnToBayButton.classList.remove('hidden');
                 }
            }
            garageNavDoor.addEventListener('click', () => {
                currentGarageRoom = 1;
                setupGarageRoom(1);
            });
            returnToBayButton.addEventListener('click', () => {
                currentGarageRoom = 0;
                setupGarageRoom(0);
            });

            // --- Hacking Console Logic ---
            accessTerminalButton.addEventListener('click', () => hackingConsoleContainer.classList.remove('hidden'));
            closeConsoleBtn.addEventListener('click', () => hackingConsoleContainer.classList.add('hidden'));

            consoleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const command = consoleInput.value.trim().toUpperCase();
                    typeToConsole(`> ${consoleInput.value}`);
                    consoleInput.value = '';
                    processCommand(command);
                }
            });

            function typeToConsole(text, isResponse = false) {
                const p = document.createElement('p');
                if (isResponse) p.style.color = "#A98F64";
                consoleOutput.appendChild(p);
                let i = 0;
                const interval = setInterval(() => {
                    p.textContent += text[i];
                    i++;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    if (i === text.length) clearInterval(interval);
                }, 20);
            }

            function processCommand(command) {
                 setTimeout(() => {
                    if (command === 'LV-GTS-MUSH') {
                        typeToConsole('ACCESSING ARCHIVE LV-GTS-MUSH...', true);
                        setTimeout(() => typeToConsole('DECRYPTING PAYLOAD...', true), 500);
                        setTimeout(() => typeToConsole('DOWNLOAD COMPLETE. LINK: [placeholder_link]', true), 1500);
                    } else if (command === 'REDLININ-PROTO-01') {
                        typeToConsole('ACCESS GRANTED. DISPLAYING PROTOCOL 01...', true);
                         setTimeout(() => typeToConsole('LORE: The REDLININ\' program was initiated to push the boundaries of sonic and automotive fusion. Early prototypes focused on raw energy transfer between engine harmonics and synthesized waveforms.', true), 500);
                    } else {
                        typeToConsole('ERROR: COMMAND NOT RECOGNIZED.', true);
                    }
                 }, 300);
            }

            // --- News Ticker Logic ---
            function populateNewsTicker() {
                const headlines = [
                    "VERSTAPPEN DOMINATES AT SPA; SECURES ANOTHER CONVINCING VICTORY",
                    "PENSKE AND GANASSI BATTLE HEATS UP IN INDYCAR CHAMPIONSHIP CHASE",
                    "PORSCHE GT3 TEAM CLAIMS ENDURANCE VICTORY AT NURBURGRING",
                    "FORMULA E ANNOUNCES NEW CITY CIRCUIT FOR UPCOMING SEASON",
                    "RISING STAR PIASTRI SCORES MAIDEN F1 PODIUM FINISH"
                ];
                const ticker = document.getElementById('news-ticker');
                let tickerContent = '';
                headlines.forEach(headline => {
                    tickerContent += `<p>${headline}</p>`;
                });
                // Repeat content to ensure a smooth, continuous loop
                ticker.innerHTML = tickerContent.repeat(5);
            }


            // --- MP3 Player & Visualizer Logic ---
            function setupAudio() {
                gainNode = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 128; 
                
                gainNode.connect(audioContext.destination);
                analyser.connect(gainNode);
                
                gainNode.gain.value = volumeSlider.value / 100;
                
                drawVisualizer(); 
            }

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);

                if (!analyser || !isPlaying) {
                    visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                    return;
                }

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                
                const barWidth = (visualizerCanvas.width / bufferLength) * 2;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 4; 
                    
                    visualizerCtx.fillStyle = '#40E0D0';
                    visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 2; 
                }
            }


            function shufflePlaylist() {
                for (let i = playlist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
                }
            }


            async function loadTrack(index, autoplay = false) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (audioSource) {
                    try { audioSource.stop(); } catch (e) {}
                }
                isPlaying = false;
                startOffset = 0;
                audioBuffer = null; 
                playPauseBtn.textContent = '▶';
                trackDisplay.textContent = 'LOADING...';
                
                const trackFile = playlist[index].file;

                try {
                    const response = await fetch(trackFile);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    audioBuffer = decodedBuffer;
                    trackDisplay.textContent = `${playlist[index].title.toUpperCase()}`;
                    seekSlider.max = audioBuffer.duration;
                    seekSlider.value = 0;
                    if (autoplay) {
                       playTrack();
                    }
                } catch (e) {
                    console.error('Error loading audio:', e);
                    trackDisplay.textContent = 'ERROR LOADING TRACK';
                }
            }

            function playTrack() {
                if (!audioBuffer) return;
                
                if (isPlaying) {
                   try { audioSource.stop(); } catch (e) {}
                }
                
                audioSource = audioContext.createBufferSource();
                audioSource.buffer = audioBuffer;
                audioSource.connect(analyser); 

                audioStartTime = audioContext.currentTime - startOffset;
                audioSource.start(0, startOffset);
                isPlaying = true;
                playPauseBtn.textContent = '⏸';
                
                updateLoop();
                
                audioSource.onended = () => {
                    if (isPlaying && (audioContext.currentTime - audioStartTime) >= audioBuffer.duration - 0.1) {
                        playNext();
                    }
                };
            }

            function pauseTrack() {
                if (!isPlaying) return;
                cancelAnimationFrame(animationFrameId);
                startOffset = audioContext.currentTime - audioStartTime;
                try { audioSource.stop(); } catch (e) {}
                isPlaying = false;
                playPauseBtn.textContent = '▶';
            }

            function updateLoop() {
                if (isPlaying && audioBuffer) {
                    const elapsedTime = audioContext.currentTime - audioStartTime;
                    seekSlider.value = elapsedTime;
                    
                    const duration = audioBuffer ? Math.floor(audioBuffer.duration) : 0;
                    timeDisplay.textContent = `${formatTime(elapsedTime)} / ${formatTime(duration)}`;

                    if (elapsedTime >= audioBuffer.duration) {
                        playNext();
                    } else {
                        animationFrameId = requestAnimationFrame(updateLoop);
                    }
                }
            }
            
            function playNext() {
                currentTrackIndex++;
                if (currentTrackIndex >= playlist.length) {
                    currentTrackIndex = 0;
                    shufflePlaylist();
                }
                loadTrack(currentTrackIndex, true);
            }

            function playPrev() {
                currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
                loadTrack(currentTrackIndex, true);
            }

            playPauseBtn.addEventListener('click', () => {
                 if (isPlaying) {
                    pauseTrack();
                } else {
                    playTrack();
                }
            });

            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);

            volumeSlider.addEventListener('input', e => {
                 if (gainNode) {
                    gainNode.gain.value = e.target.value / 100;
                 }
            });

            seekSlider.addEventListener('input', () => {
                if (!audioBuffer) return;
                cancelAnimationFrame(animationFrameId);
                startOffset = parseFloat(seekSlider.value);
                if (isPlaying) {
                   playTrack();
                }
                 updateLoop();
            });
            
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${minutes}:${secs}`;
            }

            // Draggable MP3 Player
            mp3Player.querySelector('#mp3-header').addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - mp3Player.offsetLeft;
                offsetY = e.clientY - mp3Player.offsetTop;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    mp3Player.style.left = (e.clientX - offsetX) + 'px';
                    mp3Player.style.top = (e.clientY - offsetY) + 'px';
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });


            // --- Main Menu Navigation ---
            function updateMenuSelection() {
                document.querySelectorAll('.menu-option').forEach((el, index) => {
                    if (index === currentMenuSelection) {
                        el.classList.add('selected');
                    } else {
                        el.classList.remove('selected');
                    }
                });
            }
            
            function handleMenuClick() {
                // This function is the key fix for autoplay issues.
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        if (!isMusicInitialized) {
                            setupAudio();
                            shufflePlaylist();
                            loadTrack(currentTrackIndex, true); // Autoplay first track
                            isMusicInitialized = true;
                        }
                    });
                }
                 if (currentState === 'main-menu') {
                    const selectedOption = menuOptions[currentMenuSelection];
                    if (selectedOption === 'new-game') transition('hq-lobby');
                    else if (selectedOption === 'settings') transition('department-settings'); // Placeholder
                }
            }


            menuOptionNewGame.addEventListener('mouseover', () => { currentMenuSelection = 0; updateMenuSelection(); });
            menuOptionSettings.addEventListener('mouseover', () => { currentMenuSelection = 1; updateMenuSelection(); });
            menuOptionNewGame.addEventListener('click', handleMenuClick);
            menuOptionSettings.addEventListener('click', () => { if (currentState === 'main-menu') transition('department-settings'); });


            window.addEventListener('keydown', (e) => {
                if (currentState === 'main-menu') {
                    if (e.key === 'ArrowUp' || e.key === 'w') {
                        currentMenuSelection = (currentMenuSelection - 1 + menuOptions.length) % menuOptions.length;
                        updateMenuSelection();
                    } else if (e.key === 'ArrowDown' || e.key === 's') {
                        currentMenuSelection = (currentMenuSelection + 1) % menuOptions.length;
                        updateMenuSelection();
                    } else if (e.key === 'Enter') {
                        handleMenuClick();
                    }
                }
            });

            // --- Clock Logic ---
            function updateClock() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                hudClock.textContent = `${hours}:${minutes}`;
            }

            // --- Event Listeners for Navigation ---
            pressStart.addEventListener('click', () => {
                 if (currentState === 'title') {
                     handleMenuClick(); // Trigger audio unlock
                    transition('main-menu');
                }
            });
            
            document.querySelectorAll('.hotspot').forEach(hotspot => {
                hotspot.addEventListener('click', () => {
                    const target = hotspot.getAttribute('data-target');
                    if (target) {
                        transition(`department-${target}`);
                    }
                });
            });
            
            backButton.addEventListener('click', () => {
                transition('hq-lobby');
            });

            // --- Initial Boot Sequence ---
            populateNewsTicker();
            setInterval(updateClock, 1000);
            updateClock();
            
            hudBar.classList.add('hidden');

            setTimeout(() => {
                lvScreen.classList.add('hidden');
                pubScreen.classList.remove('hidden');
            }, 3000);

            setTimeout(() => {
                pubScreen.classList.add('hidden');
                bootSeq.classList.add('hidden');
                titleScreen.classList.remove('hidden');
                currentState = 'title';

                redlininLogo.style.animation = 'slam-in 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                setTimeout(() => {
                    pressStart.classList.remove('hidden');
                }, 500);
            }, 6000);
        });
    </script>
</body>

</html>



