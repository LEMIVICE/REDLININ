<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDLININ' RACING HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for the "Digital Redline" Aesthetic */
        :root {
            --accent-color: #40E0D0; /* Default Cyan */
            --locked-color: #FF2D00; /* Red for locked elements */
        }
        body {
            background-color: #000000;
            color: #EFEFEF;
            font-family: 'Roboto Condensed', sans-serif;
            overflow: hidden;
            cursor: none;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .hidden {
            display: none !important;
        }
        
        /* CRT Scanline Overlay */
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 99999;
        }
        
        body.no-crt::after {
            display: none;
        }
        
        /* Transition Overlay */
        #transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
        }
        
        #transition-overlay.active {
            opacity: 1;
            animation: static 0.3s steps(8, end) forwards;
        }
        
        @keyframes static {
            0% { background-position: 0 0; }
            10% { background-position: -5px 5px; }
            20% { background-position: 5px -5px; }
            30% { background-position: -5px -5px; }
            40% { background-position: 5px 5px; }
            50% { background-position: 0 0; }
            100% { background-position: 0 0; }
        }


        /* HUD Bar */
        #hud-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #FF2D00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 200;
            font-family: 'Orbitron', sans-serif;
        }
        
        #hud-bar .accent-text {
            color: var(--accent-color);
        }

        #hud-left {
            display: flex;
            align-items: center;
        }

        #hud-logo {
            height: 20px;
            margin-right: 15px;
        }
        
        #hud-location {
            color: #EFEFEF;
        }

        #hud-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #audio-visualizer {
            height: 40px;
        }

        #hud-right {
             color: #EFEFEF;
        }


        /* Boot Sequence Styling */
        #boot-sequence .boot-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        #lv-emblem-screen img {
            width: 80px;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        #publisher-screen .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
            animation: fadeInOut 3s forwards;
        }
        
        /* Main Title Screen */
        #title-screen {
            background-image: url('assets/start_menu_bg.png');
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #redlinin-logo {
            position: absolute;
            width: 40%;
            max-width: 500px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(5);
            opacity: 0;
        }
        
        #press-start {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #EFEFEF;
            text-shadow: 0 0 10px #FF2D00;
            animation: blink 1s infinite;
        }

        @keyframes slam-in {
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Loading Screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 100;
        }

        #loading-icon {
            position: absolute;
            width: 100px;
            height: 100px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-image: url('assets/gold_wheel_icon.png');
            background-size: contain;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        #loading-text {
            position: absolute;
            top: calc(50% + 70px);
            left: 50%;
            transform: translateX(-50%);
            color: #EFEFEF;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
        }

        /* HQ Lobby Styling */
        #hq-lobby {
            background-size: cover;
            background-position: center;
            position: relative;
            width: 100vw;
            height: 100vh;
            padding-top: 50px; /* Account for HUD */
        }

        .hotspot {
            position: absolute;
            background-color: rgba(255, 45, 0, 0);
            border: 2px solid rgba(0,0,0,0);
            transition: all 0.3s ease;
            box-shadow: 0 0 0px var(--accent-color);
            cursor: none;
        }

        .hotspot:not(.locked):hover {
            background-color: rgba(255, 45, 0, 0.3);
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color);
        }
        
        .hotspot.locked:hover {
            background-color: rgba(255, 45, 0, 0.3);
            border: 2px solid var(--locked-color);
            box-shadow: 0 0 20px var(--locked-color);
        }

        .hotspot-label {
            position: absolute;
            top: 50%;
            left: 110%;
            transform: translateY(-50%);
            white-space: nowrap;
            background-color: #000;
            padding: 5px 10px;
            border-left: 3px solid #FF2D00;
            color: #EFEFEF;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .hotspot:hover .hotspot-label {
            opacity: 1;
        }

        /* Lobby Navigation */
        .lobby-nav {
            position: absolute;
        }
        #lobby-nav-1-to-2 {
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: pulse-cyan 2s infinite;
        }
        @keyframes pulse-cyan {
            0% { box-shadow: 0 0 5px var(--accent-color); }
            50% { box-shadow: 0 0 25px var(--accent-color); }
            100% { box-shadow: 0 0 5px var(--accent-color); }
        }
        
        /* Department View */
        #department-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            padding-top: 50px; /* Account for HUD */
        }
        
        #department-header {
             position: absolute;
             top: 10%;
             left: 50%;
             transform: translateX(-50%);
             font-family: 'Orbitron', sans-serif;
             font-size: 2rem;
             color: #EFEFEF;
             background-color: rgba(0,0,0,0.7);
             padding: 10px 30px;
             border-top: 2px solid #FF2D00;
             border-bottom: 2px solid #FF2D00;
             opacity: 0; /* for animation */
        }
        
        .header-animate {
            animation: slide-in-blurred 0.7s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes slide-in-blurred {
            0% {
                transform: translateY(-50px) translateX(-50%);
                filter: blur(5px);
                opacity: 0;
            }
            100% {
                transform: translateY(0) translateX(-50%);
                filter: blur(0);
                opacity: 1;
            }
        }
        
        .department-button {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: #EFEFEF;
            background-color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: none;
            transition: all 0.3s ease;
        }
        
        #back-button {
            border: 2px solid var(--accent-color);
        }
        #back-button:hover {
            background-color: var(--accent-color);
            color: #000;
            box-shadow: 0 0 15px var(--accent-color);
        }
        .return-button {
             border: 2px solid #FF2D00;
        }
        .return-button:hover {
            background-color: #FF2D00;
            color: #000;
        }
        
        /* Custom Cursor */
        #cursor-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent-color);
            border-radius: 50%;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 0 5px var(--accent-color);
            transition: transform 0.1s ease-out;
        }
        
        #cursor-ring {
            width: 30px;
            height: 30px;
            border: 2px solid #EFEFEF;
            border-radius: 50%;
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        
        body:hover #cursor-ring {
            opacity: 1;
        }
        
        /* Main Menu */
        #main-menu {
            background-image: url('assets/main_menu_bg.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 2rem;
        }

        .menu-option {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: #EFEFEF;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            cursor: none;
            transition: all 0.3s ease;
            padding: 10px 20px;
            border: 2px solid transparent;
        }
        
        .menu-option.selected {
            color: #FF2D00;
            text-shadow: 0 0 15px #FF2D00;
            border: 2px solid #FF2D00;
        }

        /* News Ticker */
        #news-ticker-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #FF2D00;
            height: 40px;
            overflow: hidden;
        }

        #news-ticker {
            display: flex;
            align-items: center;
            height: 100%;
            white-space: nowrap;
            animation: marquee 120s linear infinite;
        }

        #news-ticker p {
            padding: 0 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            color: #EFEFEF;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* MP3 Player */
        #mp3-player {
            position: absolute;
            bottom: 60px; /* Above the ticker */
            right: 20px;
            width: 300px;
            background-color: #111;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(64, 224, 208, 0.3);
            font-family: 'Orbitron', sans-serif;
            user-select: none;
            z-index: 50;
        }

        #mp3-header {
            background-color: #222;
            padding: 5px 10px;
            cursor: move;
            border-bottom: 2px solid var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #mp3-header img {
            height: 15px;
        }

        #mp3-body {
            padding: 15px;
        }
        
        #track-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #album-art {
            width: 60px;
            height: 60px;
            margin-right: 10px;
            border: 1px solid var(--accent-color);
        }

        #track-display-container {
            flex-grow: 1;
            background-color: #000;
            overflow: hidden;
            position: relative;
            height: 28px; /* Fixed height */
        }
        
        #track-display {
            color: #EFEFEF;
            text-align: left;
            padding: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            width: auto;
        }

        .scroll-text {
            animation: scroll-left 10s linear infinite;
        }
        
        @keyframes scroll-left {
            0%   { transform: translateX(100%); }
            10%  { transform: translateX(100%); }
            90%  { transform: translateX(-100%); }
            100% { transform: translateX(-100%); }
        }

        .slider-container {
            margin-bottom: 10px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #000;
            border: 1px solid var(--accent-color);
            outline: none;
            cursor: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #FF2D00;
            cursor: none;
            border: 1px solid #EFEFEF;
        }

        #controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        #controls button {
            background: none;
            border: none;
            color: #EFEFEF;
            font-size: 1.2rem;
            cursor: none;
            transition: color 0.2s ease;
        }

        #controls button:hover {
            color: #FF2D00;
        }
        
        /* Boiler Room & Puzzles */
        .glitch-artifact {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #FF2D00;
            cursor: none;
            z-index: 1000;
            animation: glitch-anim 1.5s infinite steps(8);
        }

        @keyframes glitch-anim {
            0% { transform: translate(0, 0); opacity: 0.8; }
            10% { transform: translate(-5px, 5px); }
            20% { transform: translate(5px, -5px); }
            30% { transform: translate(-5px, -5px); }
            40% { transform: translate(5px, 5px); }
            50% { opacity: 0.5; clip-path: inset(50% 0 0 0); }
            60% { clip-path: inset(0 50% 50% 0); }
            70% { clip-path: inset(25% 25% 25% 25%); }
            80% { opacity: 1; }
            90% { transform: skew(10deg, 10deg); }
            100% { transform: translate(0, 0); opacity: 0.8; }
        }

        #boiler-room-hotspot {
            bottom: 2%;
            left: 2%;
            width: 100px;
            height: 50px;
            border-radius: 5px;
            background-color: rgba(100, 100, 100, 0.5);
            border: 2px solid #555;
            transform: perspective(100px) rotateX(45deg);
        }

        #notification {
            position: absolute;
            top: 60px; /* Below HUD */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--accent-color);
            padding: 15px 25px;
            border: 2px solid var(--accent-color);
            border-radius: 5px;
            z-index: 200;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            text-shadow: 0 0 5px var(--accent-color);
        }
        
        #boiler-room {
            background-image: url('assets/sfx/boiler_room_bg.png');
        }

        /* Hacking Console */
        #hacking-console-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }
        
        #console-window {
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background-image: url('assets/led_console.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            padding: 8% 10%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #console-output {
            flex-grow: 1;
            background-color: rgba(0, 20, 0, 0.8);
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #00FF00;
        }
        
        #console-input-line {
            display: flex;
            padding-top: 10px;
        }

        #console-input-line span {
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
        }
        
        #console-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: #00FF00;
            font-family: 'Courier New', Courier, monospace;
            outline: none;
        }
        
        #close-console {
            position: absolute;
            top: 12%;
            right: 17%;
            color: #FF2D00;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: none;
        }
        
        /* DATALAB & LOUNGE Navigation */
        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            padding: 20px 10px;
            font-size: 2rem;
            cursor: none;
            z-index: 160;
            transition: all 0.2s ease;
        }
        .nav-button:hover {
             background-color: var(--accent-color);
             color: #000;
        }
        .nav-left { left: 2%; }
        .nav-right { right: 2%; }

        #access-terminal-button {
             position: absolute;
             bottom: 12%;
             left: 50%;
             transform: translateX(-50%);
             font-family: 'Orbitron', sans-serif;
             font-size: 1.2rem;
             color: #EFEFEF;
             background-color: #000;
             padding: 10px 20px;
             border: 2px solid #FF2D00;
             border-radius: 5px;
             cursor: none;
             transition: all 0.3s ease;
        }
        #access-terminal-button:hover {
            background-color: #FF2D00;
            color: #000;
            box-shadow: 0 0 15px #FF2D00;
        }
        
        #hacking-console-container.hidden {
            display: none !important;
        }
        
        /* QL SIM */
        #ql-sim-cockpit {
            background-image: url('assets/ql_sim_bg.png');
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }
        
        #ql-hud {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 900px;
            height: 150px;
            background-color: rgba(0,0,0,0.7);
            border: 2px solid var(--accent-color);
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        #ql-hud p {
            font-size: 1.5rem;
            text-shadow: 0 0 5px var(--accent-color);
        }
        #ql-hud #ql-controls button {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            font-size: 1.2rem;
            padding: 5px 10px;
            margin: 0 10px;
        }
        
        /* Garage Schematics */
        .schematic-hotspot {
            position: absolute;
        }
        .schematic-hotspot .hotspot-label {
            left: 50%;
            top: -40px;
            transform: translateX(-50%);
            width: max-content;
        }

        /* Settings/Driver Data */
        #driver-data-screen {
             padding: 80px 5%;
             color: #EFEFEF;
             width: 100vw;
             height: 100vh;
             background-color: #050505;
        }
        #driver-data-screen h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: #FF2D00;
            border-bottom: 2px solid #FF2D00;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .data-block {
             margin-bottom: 30px;
        }
        .data-block h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        #color-swatches {
            display: flex;
            gap: 10px;
        }
        .swatch {
            width: 30px;
            height: 30px;
            border: 2px solid #EFEFEF;
            cursor: none;
        }
        .swatch.selected {
             box-shadow: 0 0 10px #FFF;
        }
        
        /* Race Select Screen */
        #race-select-screen {
            display: flex;
            width: 100%;
            height: 100%;
            padding-top: 50px;
            background-color: #050505;
        }

        #album-select-view, #track-select-view {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #album-select-view h2 {
             font-family: 'Orbitron', sans-serif;
             font-size: 2rem;
             color: #FF2D00;
             margin-bottom: 2rem;
        }

        .album-choice {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            padding: 15px 30px;
            margin: 10px;
            border: 2px solid var(--accent-color);
            cursor: none;
            transition: all 0.2s ease;
        }
        .album-choice:hover {
            background-color: var(--accent-color);
            color: #000;
        }

        #track-select-view {
            flex-direction: row;
            gap: 2%;
            padding: 2%;
        }

        #track-list-container {
            width: 35%;
            height: 90%;
            background-color: rgba(0,0,0,0.5);
            border: 2px solid var(--accent-color);
            padding: 15px;
            overflow-y: auto;
        }
        
        #track-list-container h3 {
            font-family: 'Orbitron', sans-serif;
            color: #FF2D00;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .track-item {
            padding: 10px;
            font-family: 'Orbitron', sans-serif;
            cursor: none;
            border-bottom: 1px solid #333;
        }

        .track-item.selected {
            background-color: var(--accent-color);
            color: #000;
        }

        #track-detail-container {
            width: 63%;
            height: 90%;
            background-color: rgba(0,0,0,0.5);
            border: 2px solid var(--accent-color);
            padding: 20px;
        }
        
        #track-detail-image {
            width: 100%;
            height: 50%;
            background-size: cover;
            background-position: center;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        #track-detail-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: #FF2D00;
            margin-bottom: 10px;
        }
        #track-detail-lore {
            font-family: 'Roboto Condensed', sans-serif;
            height: 30%;
            overflow-y: auto;
        }

    </style>
</head>

<body>

    <div id="transition-overlay"></div>

    <!-- HUD Bar -->
    <div id="hud-bar" class="hidden">
        <div id="hud-left">
            <img id="hud-logo" src="assets/redlinin_logo.png" alt="Redlinin Logo">
            <span id="hud-location"></span>
        </div>
        <div id="hud-center">
            <canvas id="audio-visualizer" width="300" height="40"></canvas>
        </div>
        <div id="hud-right">
            <span id="hud-clock"></span>
        </div>
    </div>


    <!-- Custom Cursor -->
    <div id="cursor-dot"></div>
    <div id="cursor-ring"></div>
    
    <!-- Initial Screen -->
    <div id="initial-screen" style="width:100vw; height: 100vh; display: flex; justify-content:center; align-items:center;">
         <h1 id="initial-press-start" class="font-orbitron text-2xl" style="color: #EFEFEF; text-shadow: 0 0 10px #FF2D00; animation: blink 1s infinite;">ENTER</h1>
    </div>


    <!-- Boot Sequence -->
    <div id="boot-sequence" class="hidden">
        <div id="lv-emblem-screen" class="boot-screen">
             <img src="assets/lemi_vice_logo.png" alt="Lemi Vice Emblem">
        </div>
        <div id="publisher-screen" class="boot-screen hidden">
            <h2 class="logo">REDLININ' Interactive</h2>
        </div>
    </div>

    <!-- Main Title Screen -->
    <div id="title-screen" class="hidden">
        <img id="redlinin-logo" src="assets/redlinin_logo.png" alt="Redlinin Logo">
        <h1 id="press-start" class="hidden">PRESS START</h1>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="hidden" style="width: 100vw; height: 100vh;">
         <div id="menu-option-new-game" class="menu-option selected">NEW GAME</div>
         <div id="menu-option-settings" class="menu-option">DRIVER DATA</div>
    </div>


    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden">
        <div id="loading-icon"></div>
        <p id="loading-text">NOW LOADING</p>
    </div>

    <!-- Main HQ Hub -->
    <div id="hq-lobby" class="hidden">
        <!-- Department Hotspots -->
        <div class="department-hotspot hotspot" style="top: 35%; left: 2%; width: 12%; height: 50%; border-radius: 10px;" data-target="garage">
            <div class="hotspot-label">THE GARAGE</div>
        </div>
        <div class="department-hotspot hotspot" style="top: 40%; left: 45%; width: 150px; height: 150px;" data-target="datalab">
            <div class="hotspot-label">THE DATALAB</div>
        </div>
        <div class="department-hotspot hotspot locked" style="top: 40%; right: 5%; width: 20%; height: 50%;" data-target="lounge">
             <div class="hotspot-label">LOCKED</div>
        </div>
        <div class="department-hotspot hotspot locked" style="top: 55%; left: 88%; width: 80px; height: 120px;" data-target="rally">
             <div class="hotspot-label">LOCKED</div>
        </div>
        <div class="department-hotspot hotspot locked" style="top: 65%; left: 70%; width: 180px; height: 100px;" data-target="ql-sim">
             <div class="hotspot-label">LOCKED</div>
        </div>
         <div class="department-hotspot hotspot" style="top: 40%; left: 30%; width: 120px; height: 120px;" data-target="race-select">
            <div class="hotspot-label">RACE SELECT</div>
        </div>

        
        <!-- Boiler Room Puzzle Trigger -->
        <div id="boiler-room-hotspot" class="hotspot hidden" data-target="boiler-room">
             <div class="hotspot-label">ACCESS GRATE</div>
        </div>

        <!-- Lobby Navigation Hotspots -->
        <div id="lobby-nav-1-to-2" class="lobby-nav hotspot" style="top: 40%; left: 47%; width: 120px; height: 120px;">
            <div class="hotspot-label" style="top: -30px; left: 50%; transform: translateX(-50%);">NEXT AREA</div>
        </div>
         <div id="lobby-nav-2-to-1" class="lobby-nav hotspot" style="top: 20%; left: 5%; width: 15%; height: 60%; border-radius: 10px;">
            <div class="hotspot-label">PREVIOUS AREA</div>
        </div>
        <div id="lobby-nav-2-to-3" class="lobby-nav hotspot" style="top: 25%; left: 55%; width: 25%; height: 50%; border-radius: 10px;">
            <div class="hotspot-label">UPPER LEVEL</div>
        </div>
        <div id="lobby-nav-3-to-2" class="lobby-nav hotspot" style="top: 40%; left: 5%; width: 100px; height: 250px; border-radius: 10px;">
            <div class="hotspot-label">LOWER LEVEL</div>
        </div>
        
        <!-- News Ticker -->
        <div id="news-ticker-container">
            <div id="news-ticker"><p></p></div>
        </div>

        <!-- MP3 Player -->
        <div id="mp3-player">
            <div id="mp3-header">
                <img src="assets/redlinin_logo.png" alt="Redlinin">
                <span>SSM Player</span>
            </div>
            <div id="mp3-body">
                 <div id="track-info">
                     <img id="album-art" src="assets/REDLININ_HQ_MENU_MUSIC__ART_1080_v1.png" alt="Album Art">
                      <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; height: 60px;">
                         <div id="track-display-container">
                             <div id="track-display">NOT PLAYING</div>
                         </div>
                         <div id="time-display" style="text-align:center; font-size: 0.8rem; color: #aaa;">0:00 / 0:00</div>
                      </div>
                 </div>

                <div class="slider-container">
                    <input type="range" id="seek-slider" min="0" max="100" value="0">
                </div>
                <div class="slider-container" style="display: flex; align-items: center; gap: 5px;">
                    <span>VOL</span>
                    <input type="range" id="volume-slider" min="0" max="100" value="50">
                </div>
                <div id="controls">
                    <button id="prev-btn">⏮</button>
                    <button id="play-pause-btn">▶</button>
                    <button id="next-btn">⏭</button>
                </div>
            </div>
             <!-- Puzzle 3 -->
            <div id="puzzle-3" class="glitch-artifact" style="top: 5px; right: 5px; width:15px; height:15px;"></div>
        </div>

    </div>

    <!-- Department View -->
    <div id="department-view" class="hidden">
        <h2 id="department-header">DEPARTMENT</h2>
        <button id="back-button" class="department-button">RETURN TO HQ</button>
        <!-- Puzzle 2 Placeholder -->
        <div id="puzzle-2" class="glitch-artifact hidden department-ui" style="top: 80%; left: 10%;"></div>
        <!-- DATALAB UI -->
        <button id="datalab-nav-left" class="nav-button nav-left hidden department-ui">&lt;</button>
        <button id="datalab-nav-right" class="nav-button nav-right hidden department-ui">&gt;</button>
        <button id="access-terminal-button" class="hidden department-ui">ACCESS TERMINAL</button>
        <!-- Garage UI -->
        <div id="garage-nav-door" class="hotspot hidden department-ui" style="top: 35%; left: 2%; width: 12%; height: 50%; border-radius: 10px;">
             <div class="hotspot-label">SECONDARY BAY</div>
        </div>
        <button id="return-to-bay-button" class="department-button return-button hidden department-ui">RETURN TO MAIN BAY</button>
        <!-- Garage Schematics -->
        <div id="garage-schematics" class="hidden department-ui">
            <div class="schematic-hotspot hotspot" style="top: 50%; left: 50%; width: 100px; height: 50px;">
                 <div class="hotspot-label">FUSION ENGINE CORE</div>
            </div>
            <div class="schematic-hotspot hotspot" style="top: 70%; left: 25%; width: 50px; height: 50px;">
                 <div class="hotspot-label">AERO-GRADE TIRES</div>
            </div>
             <div class="schematic-hotspot hotspot" style="top: 30%; left: 80%; width: 80px; height: 40px;">
                 <div class="hotspot-label">DOWNFORCE SPOILER</div>
            </div>
        </div>
        <!-- Liquid Lounge UI -->
        <button id="lounge-nav-left" class="nav-button nav-left hidden department-ui">&lt;</button>
        <button id="lounge-nav-right" class="nav-button nav-right hidden department-ui">&gt;</button>
        <!-- QL SIM UI -->
        <div id="ql-sim-cockpit" class="hidden department-ui">
            <div id="ql-hud">
                <!-- QL Player will be injected here by JS -->
            </div>
        </div>
        <!-- Settings/Driver Data UI -->
        <div id="driver-data-screen" class="hidden department-ui">
             <h2>DRIVER DATA // SYSTEM SETTINGS</h2>
             <div class="data-block">
                 <h3>SESSION DATA</h3>
                 <div class="data-row"><span>DEPARTMENTS VISITED:</span><span id="data-visited">0 / 6</span></div>
                 <div class="data-row"><span>SECRETS UNLOCKED:</span><span id="data-secrets">0 / 3</span></div>
                 <!-- Puzzle 1 -->
                 <div id="puzzle-1" class="glitch-artifact" style="top: 15%; right: 5%;"></div>
             </div>
             <div class="data-block">
                 <h3>SYSTEM SETTINGS</h3>
                 <div class="data-row">
                     <span>MASTER VOLUME:</span>
                     <input type="range" id="master-volume" min="0" max="100" value="50">
                 </div>
                  <div class="data-row">
                     <span>CRT SCANLINE EFFECT:</span>
                     <input type="checkbox" id="crt-toggle" checked>
                 </div>
                 <div class="data-row">
                     <span>HUD ACCENT COLOR:</span>
                     <div id="color-swatches">
                         <div class="swatch selected" style="background-color: #40E0D0;" data-color="#40E0D0"></div>
                         <div class="swatch" style="background-color: #FFD700;" data-color="#FFD700"></div>
                         <div class="swatch" style="background-color: #BE2EC;" data-color="#BE29EC"></div>
                     </div>
                 </div>
             </div>
        </div>
        <!-- Race Select UI -->
        <div id="race-select-screen" class="hidden department-ui">
             <div id="album-select-view">
                <h2>SELECT ALBUM</h2>
                <div class="album-choice" data-album="redlinin">REDLININ'</div>
                <div class="album-choice" data-album="gts">REDLININ':GTS (GARAGETUNE SESSIONS)</div>
             </div>
             <div id="track-select-view" class="hidden">
                <div id="track-list-container">
                    <h3 id="track-list-header">TRACK LIST</h3>
                    <div id="track-list"></div>
                </div>
                <div id="track-detail-container">
                    <div id="track-detail-image"></div>
                    <h2 id="track-detail-title"></h2>
                    <p id="track-detail-lore"></p>
                </div>
             </div>
        </div>
    </div>

    <!-- Hacking Console -->
    <div id="hacking-console-container" class="hidden">
        <div id="console-window">
             <div id="console-output"></div>
             <div id="console-input-line">
                 <span>>&nbsp;</span>
                 <input type="text" id="console-input" autofocus>
             </div>
        </div>
        <button id="close-console">X</button>
    </div>


    <!-- Notification Area -->
    <div id="notification" class="hidden"></div>
    
    <!-- Ambient Audio -->
    <audio id="bootup-audio"><source src="assets/sfx/bootup_chime.mp3" type="audio/mpeg"></audio>
    <audio id="racecar-sfx-audio"><source src="assets/music/0-100_DreamCast_Version.mp3" type="audio/mpeg"></audio>
    <audio id="boiler-room-audio" loop><source src="assets/sfx/boiler_room_ambience.wav" type="audio/wav"></audio>
    <audio id="garage-audio" loop><source src="assets/sfx/garage_repair_sfx.mp3" type="audio/mpeg"></audio>
    <audio id="datalab-audio" loop><source src="assets/sfx/datalab_ambience.wav" type="audio/wav"></audio>
    <audio id="lounge-audio" loop><source src="assets/sfx/lounge_ambience.wav" type="audio/wav"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Cache ---
            const initialScreen = document.getElementById('initial-screen');
            const initialPressStart = document.getElementById('initial-press-start');
            const bootSeq = document.getElementById('boot-sequence');
            const lvScreen = document.getElementById('lv-emblem-screen');
            const pubScreen = document.getElementById('publisher-screen');
            const titleScreen = document.getElementById('title-screen');
            const redlininLogo = document.getElementById('redlinin-logo');
            const pressStart = document.getElementById('press-start');
            const loadingScreen = document.getElementById('loading-screen');
            const hqLobby = document.getElementById('hq-lobby');
            const departmentView = document.getElementById('department-view');
            const departmentHeader = document.getElementById('department-header');
            const backButton = document.getElementById('back-button');
            const mainMenu = document.getElementById('main-menu');
            const menuOptionNewGame = document.getElementById('menu-option-new-game');
            const menuOptionSettings = document.getElementById('menu-option-settings');
            const transitionOverlay = document.getElementById('transition-overlay');

            // --- HUD Elements ---
            const hudBar = document.getElementById('hud-bar');
            const hudLocation = document.getElementById('hud-location');
            const hudClock = document.getElementById('hud-clock');
            const visualizerCanvas = document.getElementById('audio-visualizer');
            const visualizerCtx = visualizerCanvas.getContext('2d');

            // --- Custom Cursor ---
            const cursorDot = document.getElementById('cursor-dot');
            const cursorRing = document.getElementById('cursor-ring');

            window.addEventListener('mousemove', e => {
                cursorDot.style.left = e.clientX + 'px';
                cursorDot.style.top = e.clientY + 'px';
                cursorRing.style.left = (e.clientX - 13) + 'px';
                cursorRing.style.top = (e.clientY - 13) + 'px';
            });
            
            document.body.addEventListener('mousedown', () => cursorDot.style.transform = 'scale(2)');
            document.body.addEventListener('mouseup', () => cursorDot.style.transform = 'scale(1)');

            // --- Game State & Data ---
            let currentState = 'initial';
            let currentMenuSelection = 0;
            const menuOptions = ['new-game', 'settings'];
            let playerData = {
                visitedDepartments: new Set(),
                puzzlesFound: { 'puzzle-1': false, 'puzzle-2': false, 'puzzle-3': false },
                settings: {
                    masterVolume: 50,
                    crtEffect: true,
                    accentColor: '#40E0D0'
                },
                hasEnteredLobby: false
            };
            
            const puzzles = {
                'puzzle-1': document.getElementById('puzzle-1'),
                'puzzle-2': document.getElementById('puzzle-2'),
                'puzzle-3': document.getElementById('puzzle-3'),
            };
            
            // --- Department States & Elements ---
            let currentLobbyRoom = 0, currentDatalabRoom = 0, currentGarageRoom = 0, currentLoungeRoom = 0;
            const lobbyBackgrounds = ['assets/hq_lobby_bg.png', 'assets/hq_lobby2_bg.png', 'assets/hq_lobby3_bg.png'];
            const datalabBackgrounds = ['assets/datalab1.png', 'assets/datalab2.png', 'assets/datalab3.png'];
            const garageBackgrounds = ['assets/garage_bg1.png', 'assets/garage_bg2.png'];
            const loungeBackgrounds = ['assets/liquid_lounge_bg.png', 'assets/liquid_lounge_bg2.png'];
            const lockedDepartments = ['lounge', 'ql-sim', 'rally'];

            const departmentHotspots = document.querySelectorAll('.department-hotspot');
            const lobbyNavHotspots = {
                '1-2': document.getElementById('lobby-nav-1-to-2'), '2-1': document.getElementById('lobby-nav-2-to-1'),
                '2-3': document.getElementById('lobby-nav-2-to-3'), '3-2': document.getElementById('lobby-nav-3-to-2'),
            };
            const datalabNavLeft = document.getElementById('datalab-nav-left'), datalabNavRight = document.getElementById('datalab-nav-right');
            const accessTerminalButton = document.getElementById('access-terminal-button');
            const garageNavDoor = document.getElementById('garage-nav-door'), returnToBayButton = document.getElementById('return-to-bay-button');
            const garageSchematics = document.getElementById('garage-schematics');
            const loungeNavLeft = document.getElementById('lounge-nav-left'), loungeNavRight = document.getElementById('lounge-nav-right');
            const qlSimCockpit = document.getElementById('ql-sim-cockpit');

            // --- Hacking Console ---
            const hackingConsoleContainer = document.getElementById('hacking-console-container');
            const consoleOutput = document.getElementById('console-output');
            const consoleInput = document.getElementById('console-input');
            const closeConsoleBtn = document.getElementById('close-console');

            // --- Driver Data / Settings ---
            const driverDataScreen = document.getElementById('driver-data-screen');
            const dataVisited = document.getElementById('data-visited');
            const dataSecrets = document.getElementById('data-secrets');
            const masterVolumeSlider = document.getElementById('master-volume');
            const crtToggle = document.getElementById('crt-toggle');
            const colorSwatches = document.querySelectorAll('.swatch');

            // --- Race Select ---
            const raceSelectScreen = document.getElementById('race-select-screen');
            const albumSelectView = document.getElementById('album-select-view');
            const trackSelectView = document.getElementById('track-select-view');
            const albumChoices = document.querySelectorAll('.album-choice');
            const trackListEl = document.getElementById('track-list');
            const trackDetailImage = document.getElementById('track-detail-image');
            const trackDetailTitle = document.getElementById('track-detail-title');
            const trackDetailLore = document.getElementById('track-detail-lore');
            let currentTrackSelection = 0;
            let currentAlbumTracks = [];
            
            // --- MP3 Player & Sound ---
            const bootupAudio = document.getElementById('bootup-audio');
            const racecarSfxAudio = document.getElementById('racecar-sfx-audio');
            const mp3Player = document.getElementById('mp3-player');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let audioSource, gainNode, analyser, audioBuffer, isPlaying = false, currentTrackIndex = 0;
            let audioStartTime = 0, startOffset = 0, animationFrameId;
            let isMusicInitialized = false;
            let userInteracted = false;
            let synth; 

            // --- Ambient Audio Elements ---
            const boilerRoomAudio = document.getElementById('boiler-room-audio');
            const garageAudio = document.getElementById('garage-audio');
            const datalabAudio = document.getElementById('datalab-audio');
            const loungeAudio = document.getElementById('lounge-audio');
            const allSounds = [boilerRoomAudio, garageAudio, datalabAudio, loungeAudio, bootupAudio, racecarSfxAudio];
            const departmentSounds = {
                'garage': garageAudio, 'datalab': datalabAudio, 'lounge': loungeAudio, 'boiler-room': boilerRoomAudio
            };
            
            // --- Data ---
             const headlines = [
                // Fictional Lemi Vice
                "LEMI VICE TAKES SURPRISE POLE AT SPECIAL STAGE 5",
                "REDLININ' RACING DEBUTS NEW AERO PACKAGE, SHOCKS COMPETITION",
                "RUMORS: LEMI VICE IN TALKS WITH LEGENDARY CHASSIS DESIGNER FOR NEXT SEASON",
                "FROM THE STUDIO TO THE SPEEDWAY: LEMI VICE SECURES PODIUM FINISH AT AUTUMN RING",
                "LEMI VICE'S CUSTOM ENGINE NOTE BECOMES FAN FAVORITE AT GRAND VALLEY",
                // F1
                "MAX VERSTAPPEN WINS ITALIAN GRAND PRIX, BREAKS F1 RECORD",
                "LEWIS HAMILTON MAKES STUNNING FERRARI DEBUT AT MONZA",
                "McLAREN LOCKS OUT 2-3 PODIUM AT TEMPLE OF SPEED",
                "CHARLES LECLERC THRILLS TIFOSI WITH STRONG QUALIFYING PERFORMANCE",
                "ALPINE CEO REAFFIRMS LONG-TERM COMMITMENT TO FORMULA 1",
                "FORMER F1 DRIVER DANIEL RICCIARDO NAMED FORD RACING AMBASSADOR",
                "KIMI ANTONELLI IMPRESSES IN MERCEDES DEBUT, SECURES TOP 10 FINISH",
                "RED BULL FINDS SURPRISING PACE AT HIGH-SPEED MONZA CIRCUIT",
                "FUTURE OF SILVERSTONE BRITISH GP SECURE WITH NEW LONG-TERM DEAL",
                "FORMULA 1 ANNOUNCES RADICAL NEW ENGINE REGULATIONS FOR 2026",
                // NASCAR
                "DENNY HAMLIN ADVANCES IN PLAYOFFS WITH DOMINANT GATEWAY WIN",
                "HENDRICK MOTORSPORTS SHAKES UP PIT CREW FOR ALEX BOWMAN AT BRISTOL",
                "GOODYEAR TO DEBUT SOFTER TIRE COMPOUND FOR BRISTOL NIGHT RACE",
                "CHRISTOPHER BELL FRUSTRATED WITH TOP 10, SAYS TEAM IS 'UNDERPERFORMING'",
                "TRACKHOUSE RACING UNDER SCRUTINY FOR POST-RACE ANTICS AT GATEWAY",
                "KYLE LARSON AND RYAN BLANEY TANGLE IN HEATED PLAYOFF BATTLE",
                "TOYOTA SECURES 200TH CUP SERIES WIN WITH HAMLIN'S VICTORY",
                "BUBBA WALLACE ENTERS CHAMPIONSHIP CONVERSATION WITH STRONG PLAYOFF START",
                "NASCAR FOUNDATION'S 'SPEEDY BEAR BRIGADE' RETURNS FOR NINTH YEAR",
                "JESSE LOVE AND CONNOR ZILISCH CARRY FRIENDSHIP INTO FIERCE XFINITY PLAYOFFS BATTLE",
                // INDYCAR
                "WILL POWER MAKES SHOCK MOVE TO ANDRETTI GLOBAL FOR 2026 SEASON",
                "COLTON HERTA NAMED TEST DRIVER FOR NEW CADILLAC FORMULA 1 TEAM",
                "ALEX PALOU WINS FOURTH CHAMPIONSHIP, GIVES CHIP GANASSI RACING 17TH TITLE",
                "INDYCAR SILLY SEASON IN FULL SWING AS TEAMS FINALIZE 2026 LINEUPS",
                "PATO O'WARD FINISHES CAREER-BEST SECOND IN INDYCAR STANDINGS",
                "DAVID MALUKAS EXPECTED TO REPLACE POWER AT TEAM PENSKE",
                "CHRISTIAN RASMUSSEN EARNS FIRST INDYCAR WIN AT MILWAUKEE MILE",
                "SCOTT DIXON AFFIRMS 'THE FIRE'S STILL THERE' FOR MORE CHAMPIONSHIP RUNS",
                "INDYCAR ENDS SEASON WITH RATINGS BUMP FOR NASHVILLE FINALE",
                "PREMA RACING SHOWS PROMISE IN DEBUT INDYCAR SEASON",
                // WEC & IMSA
                "PORSCHE PENSKE SCORES FIRST WEC HYPERCAR VICTORY OF THE SEASON AT COTA",
                "FORMER F1 DRIVER LOGAN SARGEANT TO MAKE IMSA DEBUT AT INDIANAPOLIS",
                "BMW REVEALS TWEAKED M HYBRID V8 FOR 2026 IMSA AND WEC CAMPAIGNS",
                "KEVIN ESTRE PULLS OFF DECISIVE OVERTAKE ON FERRARI TO WIN LONE STAR LE MANS",
                "PR1/MATHIASEN AND BRYAN HERTA AUTOSPORT PARTNER FOR 2026 IMSA LMP2 PROGRAM",
                "ACTION-PACKED 6-HOUR RACE AT COTA SEES DRAMA IN TREACHEROUS WET CONDITIONS",
                "TOYOTA FACES PROSPECT OF FIRST WINLESS WEC SEASON SINCE 2012",
                "FORD DEVELOPING MUSTANG GT3 EVO UPDATE FOR 2026",
                "GENESIS COMPLETES FIRST FULL-SCALE LMDH TEST FOR NEW HYPERCAR",
                "ROBERT NOAKER CLINCHES SECOND DARK HORSE CHAMPIONSHIP IN MUSTANG CHALLENGE",
                "NICO MUELLER RETURNS TO JDC-MILLER FOR FINAL TWO IMSA ROUNDS",
                "INTERSPORT RACING ANNOUNCES RETURN TO IMSA LMP2 CATEGORY IN 2026",
                "CADILLAC AND PORSCHE FACE BOP ADJUSTMENTS AHEAD OF COTA",
                "AO RACING'S FAN-FRIENDLY 'CARS AND CHARACTERS' EVENT A HUGE SUCCESS",
                "LAMBORGHINI PAUSES SC63 LMDH PROGRAMME TO FOCUS ON GT3",
                "WRT RUMORED TO TAKE OVER BMW'S IMSA FACTORY EFFORT IN 2026",
                "IMSA EXPANDS LMP3 COMPETITION WITH NEW CAR AND ENDURANCE RACES FOR 2026",
                "PEUGEOT CELEBRATES FIRST PODIUM OF THE SEASON AT COTA",
                "HYPERCAR DRIVERS REFLECT ON 'CRAZY' AQUAPLANING CONDITIONS AT LONE STAR LE MANS",
                "FORD REBRANDS FORD PERFORMANCE TO 'FORD RACING' GLOBALLY"
            ];

            const albums = {
                redlinin: {
                    name: "REDLININ'",
                    tracks: [
                         { title: 'Apricot Hill Raceway', file: 'Apricot Hill Raceway.mp3', lore: "A high-speed circuit known for its sweeping corners and unforgiving barriers. Only drivers with perfect rhythm can maintain speed through the infamous 'Apricot Curve' at the back of the track." },
                         { title: 'Autumn Ring', file: 'Autumn Ring.mp3', lore: "A technical club circuit set against a backdrop of fall foliage. Its tight, complex sequence of turns tests a car's agility and a driver's precision. A fan favorite for time attack challenges." },
                         { title: 'Complex String', file: 'Complex String.mp3', lore: "A punishing, high-G track carved into a mountainside. Known for its series of interconnected, high-speed esses and blind crests, this circuit demands bravery and a deep trust in your machine." },
                         { title: 'Deep Forest Raceway', file: 'Deep Forest Raceway.mp3', lore: "A classic course that winds through a dense, ancient forest. Its two long straights are broken up by a challenging hairpin and a series of tunnels that can disrupt a driver's sense of speed." },
                         { title: 'Grand Valley Speedway', file: 'Grand Valley Speedway.mp3', lore: "The crown jewel of the REDLININ' championship. A long, demanding circuit with extreme elevation changes, fast chicanes, and a legendary final corner that can make or break a race." },
                         { title: 'Grindelwald', file: 'Grindelwald.mp3', lore: "A scenic alpine course with breathtaking views and treacherous conditions. The narrow roads and tight hairpins leave no room for error, rewarding drivers who can balance aggression with precision." },
                         { title: 'High Speed Ring', file: 'High Speed Ring.mp3', lore: "An oval-based superspeedway with a simple layout but complex drafting dynamics. The two banked corners allow for incredible speeds, making slipstreaming and strategy paramount to victory." },
                         { title: 'Mid-Field Raceway', file: 'Mid-Field Raceway.mp3', lore: "A balanced, flowing circuit that drivers love. It features a mix of medium and high-speed corners, an over-under bridge section, and multiple overtaking opportunities." },
                         { title: 'Red Rock Valley Speedway', file: 'Red Rock Valley Speedway.mp3', lore: "A dramatic desert circuit set amongst towering red rock formations. The high heat and abrasive surface are brutal on tires, demanding careful management over a race distance." },
                         { title: 'Special Stage Route 5', file: 'Special Stage Route 5.mp3', lore: "A temporary street circuit in a sprawling metropolis. This night course is famous for its long, brilliantly lit straights and tight 90-degree corners, making it a true test of braking and acceleration." },
                         { title: 'Special Stage Route 11', file: 'Special Stage Route 11.mp3', lore: "A treacherous, high-altitude industrial course. Built on reclaimed land, it features uneven surfaces, unforgiving concrete walls, and a complex infield section that can catch out the unwary." },
                         { title: 'Tahiti Road', file: 'Tahiti Road.mp3', lore: "A beautiful but challenging dirt circuit along a tropical coastline. The loose surface and unpredictable grip make car control the ultimate skill here." },
                         { title: 'Trail Mountain', file: 'Trail Mountain.mp3', lore: "A rugged, undulating mountain pass circuit. The dramatic elevation changes and off-camber corners make this one of the most difficult and rewarding tracks on the calendar." }
                    ]
                },
                gts: {
                    name: "REDLININ':GTS",
                    tracks: [
                         // Placeholder tracks using first 5 from main playlist for now
                         { title: 'GTS Tune 1', file: 'Apricot Hill Raceway.mp3', lore: "Garage Tune Session 01: The foundational beat. A raw, stripped-down session focused on pure rhythm and low-end theory, built in the early hours of the project." },
                         { title: 'GTS Tune 2', file: 'Autumn Ring.mp3', lore: "Garage Tune Session 02: A more melodic exploration, blending synthesized pads with aggressive percussion. This track was born from experimenting with new hardware." },
                         { title: 'GTS Tune 3', file: 'Complex String.mp3', lore: "Garage Tune Session 03: The late-night drive. A hypnotic, looping track designed for focus and flow, inspired by the repetition of a perfect qualifying lap." },
                         { title: 'GTS Tune 4', file: 'Deep Forest Raceway.mp3', lore: "Garage Tune Session 04: An exercise in atmosphere. This session layers ambient textures and delayed samples to create a sense of space and speed." },
                         { title: 'GTS Tune 5', file: 'Grand Valley Speedway.mp3', lore: "Garage Tune Session 05: The victory lap. An energetic, celebratory track combining triumphant synth leads with a powerful, driving bassline." }
                    ]
                }
            };
            
            const playlist = albums.redlinin.tracks;

            const playPauseBtn = document.getElementById('play-pause-btn'), nextBtn = document.getElementById('next-btn'), prevBtn = document.getElementById('prev-btn');
            const seekSlider = document.getElementById('seek-slider'), volumeSlider = document.getElementById('volume-slider');
            const trackDisplay = document.getElementById('track-display'), timeDisplay = document.getElementById('time-display');
            const trackDisplayContainer = document.getElementById('track-display-container');
            
            // --- Sound Effects ---
            function setupSounds() {
                synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.2, sustain: 0.1, release: 0.3 }
                }).toDestination();
                applySettings(); // Sets master volume for Tone.js
            }
            
            const playSound = (note, duration = '8n') => {
                if (synth) synth.triggerAttackRelease(note, duration);
            };
            
            const playChime = (notes) => {
                 if (synth) {
                     const now = Tone.now();
                     notes.forEach((note, i) => {
                         synth.triggerAttackRelease(note, "16n", now + i * 0.05);
                     });
                 }
            };

            // --- Core Functions ---
            
            const transition = (targetState, isReturn = false) => {
                playSound('C2', '4n');
                loadingScreen.classList.remove('hidden');
                currentState = 'loading';
                
                // Stop looping sounds
                allSounds.forEach(sound => {
                    if (sound.loop) { 
                        sound.pause();
                        sound.currentTime = 0;
                    }
                });

                // Specifically fade out the menu theme when going to the lobby
                if (targetState === 'hq-lobby' && racecarSfxAudio && !racecarSfxAudio.paused) {
                    let fadeOutInterval = setInterval(() => {
                        if (racecarSfxAudio.volume > 0.1) {
                            racecarSfxAudio.volume -= 0.1;
                        } else {
                            clearInterval(fadeOutInterval);
                            racecarSfxAudio.pause();
                            racecarSfxAudio.currentTime = 0;
                            // Don't reset volume to 1 here, let master volume handle it
                        }
                    }, 100);
                }

                setTimeout(() => {
                    // Hide all major screens
                    [titleScreen, hqLobby, departmentView, mainMenu, bootSeq, initialScreen].forEach(el => el.classList.add('hidden'));
                    
                    // Hide all department-specific UI
                    document.querySelectorAll('.department-ui').forEach(el => el.classList.add('hidden'));
                    departmentHeader.classList.remove('header-animate');
                    backButton.textContent = "RETURN TO HQ"; // Reset button text

                    let locationText = '';
                    let showHud = false;

                    if (targetState === 'hq-lobby') {
                        showHud = true;
                        hqLobby.classList.remove('hidden');
                        currentState = 'hq-lobby';
                        locationText = 'LOCATION: HQ LOBBY';
                        if (!playerData.hasEnteredLobby) {
                             playerData.hasEnteredLobby = true;
                             savePlayerData();
                        }
                        setupLobbyRoom(currentLobbyRoom);
                        
                        if (isMusicInitialized) {
                            if (isReturn) {
                                playNext(); // Start a new song on return
                            } else if (!isPlaying) {
                                playTrack(); // Resume if paused
                            }
                        }

                    } else if (targetState.startsWith('department-')) {
                        showHud = true;
                        departmentView.classList.remove('hidden');
                        currentState = 'department';
                        const department = targetState.split('-')[1].replace('race_select','race-select');
                        
                        playerData.visitedDepartments.add(department);
                        savePlayerData();

                        const departmentName = `THE ${department.toUpperCase().replace('QLSIM', 'QL SIMULATOR').replace('SETTINGS', 'DRIVER DATA').replace('RACE-SELECT', 'RACE SELECT')}`;
                        departmentHeader.textContent = departmentName;
                        void departmentHeader.offsetWidth; // Trigger reflow to restart animation
                        departmentHeader.classList.add('header-animate');

                        locationText = `DEPT: ${departmentName}`;
                        
                        if (isPlaying) pauseTrack();
                        if (departmentSounds[department]) departmentSounds[department].play();
                        
                        // Department Specific Setup
                        if (department === 'datalab') setupDatalabRoom(currentDatalabRoom = 0);
                        else if (department === 'garage') setupGarageRoom(currentGarageRoom = 0);
                        else if (department === 'lounge') setupLoungeRoom(currentLoungeRoom = 0);
                        else if (department === 'ql-sim') {
                            qlSimCockpit.classList.remove('hidden');
                            setupQlSimPlayer();
                        } else if (department === 'settings') {
                            driverDataScreen.classList.remove('hidden');
                            backButton.textContent = "RETURN TO MAIN MENU";
                            updateDriverDataUI();
                        } else if (department === 'race-select') {
                            raceSelectScreen.classList.remove('hidden');
                            setupRaceSelect();
                        } else if(department !== 'boiler-room') {
                            departmentView.style.backgroundImage = "none";
                            departmentView.style.backgroundColor = "#111";
                        }


                    } else if (targetState === 'main-menu') {
                        mainMenu.classList.remove('hidden');
                        currentState = 'main-menu';
                        updateMenuSelection();
                    } else if (targetState === 'title-screen') {
                         titleScreen.classList.remove('hidden');
                         currentState = 'title';
                         setTimeout(() => pressStart.classList.remove('hidden'), 500);
                    }
                    
                    hudBar.classList.toggle('hidden', !showHud);
                    if(showHud) hudLocation.textContent = locationText;

                    loadingScreen.classList.add('hidden');

                }, 2300); // Extended loading time
            };
            
            // --- Player Data & Settings ---
            function savePlayerData() {
                 localStorage.setItem('redlininPlayerData', JSON.stringify({
                    ...playerData,
                    visitedDepartments: [...playerData.visitedDepartments],
                    puzzlesFound: playerData.puzzlesFound
                }));
            }

            function loadPlayerData() {
                const savedData = localStorage.getItem('redlininPlayerData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // A simple merge to avoid errors if new properties are added to playerData
                    Object.keys(playerData).forEach(key => {
                        if (parsedData[key] !== undefined) {
                            if (key === 'visitedDepartments') {
                                playerData[key] = new Set(parsedData[key]);
                            } else if (key === 'puzzlesFound' && typeof parsedData[key] === 'object') {
                                // Ensure puzzlesFound is a proper object
                                playerData[key] = { ...playerData.puzzlesFound, ...parsedData[key]};
                            }
                            else {
                                playerData[key] = parsedData[key];
                            }
                        }
                    });
                }
                applySettings();
            }

            function applySettings() {
                document.documentElement.style.setProperty('--accent-color', playerData.settings.accentColor);
                document.body.classList.toggle('no-crt', !playerData.settings.crtEffect);
                if (gainNode) gainNode.gain.value = playerData.settings.masterVolume / 100;
                if(Tone.Master) Tone.Master.volume.value = Tone.gainToDb(playerData.settings.masterVolume / 100);
                 allSounds.forEach(sound => {
                    sound.volume = (playerData.settings.masterVolume / 100);
                });
            }
            
            function updateDriverDataUI() {
                const secretsFound = Object.values(playerData.puzzlesFound).filter(Boolean).length;
                dataVisited.textContent = `${playerData.visitedDepartments.size} / 6`;
                dataSecrets.textContent = `${secretsFound} / 3`;
                masterVolumeSlider.value = playerData.settings.masterVolume;
                crtToggle.checked = playerData.settings.crtEffect;
                colorSwatches.forEach(swatch => {
                    swatch.classList.toggle('selected', swatch.dataset.color === playerData.settings.accentColor);
                });
                // Show/hide puzzle 1 based on lobby entry
                puzzles['puzzle-1'].classList.toggle('hidden', playerData.hasEnteredLobby || playerData.puzzlesFound['puzzle-1']);
            }

            masterVolumeSlider.addEventListener('input', (e) => {
                playerData.settings.masterVolume = e.target.value;
                applySettings();
            });
            masterVolumeSlider.addEventListener('change', savePlayerData);

            crtToggle.addEventListener('change', (e) => {
                playerData.settings.crtEffect = e.target.checked;
                applySettings();
                savePlayerData();
            });

            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', () => {
                    playSound('G4');
                    playerData.settings.accentColor = swatch.dataset.color;
                    applySettings();
                    updateDriverDataUI();
                    savePlayerData();
                });
            });

            // Puzzle & Secret Logic
            const showNotification = (text) => {
                 const notification = document.getElementById('notification');
                 notification.textContent = text;
                 notification.classList.remove('hidden');
                 setTimeout(() => notification.classList.add('hidden'), 3000);
            };

            const checkPuzzlesSolved = () => {
                const allSolved = Object.values(playerData.puzzlesFound).every(Boolean);
                if (allSolved) {
                    showNotification('SECURITY GRATE UNLOCKED IN HQ LOBBY');
                    boilerRoomHotspot.classList.remove('hidden');
                }
            };
            
            Object.keys(puzzles).forEach(key => {
                puzzles[key].addEventListener('click', () => {
                    if (!playerData.puzzlesFound[key]) {
                        const puzzleNum = key.split('-')[1];
                        playChime(['C5', 'E5', 'G5']);
                        playerData.puzzlesFound[key] = true;
                        puzzles[key].classList.add('hidden');
                        showNotification(`ARTIFACT FRAGMENT ${puzzleNum}/3 COLLECTED`);
                        savePlayerData();
                        checkPuzzlesSolved();
                    }
                });
            });
            
            // Department Logic (Lobby, Datalab, Garage, QL Sim, Race Select)
            function setupLobbyRoom(roomIndex) {
                hqLobby.style.backgroundImage = `url(${lobbyBackgrounds[roomIndex]})`;
                departmentHotspots.forEach(el => el.classList.add('hidden'));
                Object.values(lobbyNavHotspots).forEach(el => el.classList.add('hidden'));

                if (roomIndex === 0) {
                    ['garage', 'rally'].forEach(id => document.querySelector(`.department-hotspot[data-target="${id}"]`).classList.remove('hidden'));
                    lobbyNavHotspots['1-2'].classList.remove('hidden');
                } else if (roomIndex === 1) {
                    ['datalab', 'race-select', 'ql-sim'].forEach(id => document.querySelector(`.department-hotspot[data-target="${id}"]`).classList.remove('hidden'));
                    lobbyNavHotspots['2-1'].classList.remove('hidden');
                    lobbyNavHotspots['2-3'].classList.remove('hidden');
                } else if (roomIndex === 2) {
                    document.querySelector('.department-hotspot[data-target="lounge"]').classList.remove('hidden');
                    lobbyNavHotspots['3-2'].classList.remove('hidden');
                }
            }
            
            Object.keys(lobbyNavHotspots).forEach(key => {
                lobbyNavHotspots[key].addEventListener('click', () => {
                    const [from, to] = key.split('-').map(Number);
                    currentLobbyRoom = to - 1;
                    setupLobbyRoom(currentLobbyRoom);
                });
            });
            
            function setupDatalabRoom(roomIndex) {
                 departmentView.style.backgroundImage = `url(${datalabBackgrounds[roomIndex]})`;
                 datalabNavLeft.classList.remove('hidden');
                 datalabNavRight.classList.remove('hidden');
                 if (roomIndex === 1) {
                     if (!playerData.puzzlesFound['puzzle-2']) puzzles['puzzle-2'].classList.remove('hidden');
                     accessTerminalButton.classList.remove('hidden');
                 } else {
                     puzzles['puzzle-2'].classList.add('hidden');
                     accessTerminalButton.classList.add('hidden');
                 }
            }
            
            datalabNavLeft.addEventListener('click', () => { currentDatalabRoom = (currentDatalabRoom - 1 + datalabBackgrounds.length) % datalabBackgrounds.length; setupDatalabRoom(currentDatalabRoom); });
            datalabNavRight.addEventListener('click', () => { currentDatalabRoom = (currentDatalabRoom + 1) % datalabBackgrounds.length; setupDatalabRoom(currentDatalabRoom); });

            function setupGarageRoom(roomIndex) {
                 departmentView.style.backgroundImage = `url(${garageBackgrounds[roomIndex]})`;
                 if(roomIndex === 0) {
                     garageNavDoor.classList.remove('hidden');
                     garageSchematics.classList.remove('hidden');
                     returnToBayButton.classList.add('hidden');
                 } else {
                     garageNavDoor.classList.add('hidden');
                     garageSchematics.classList.add('hidden');
                     returnToBayButton.classList.remove('hidden');
                 }
            }
            garageNavDoor.addEventListener('click', () => { currentGarageRoom = 1; setupGarageRoom(1); });
            returnToBayButton.addEventListener('click', () => { currentGarageRoom = 0; setupGarageRoom(0); });

            function setupLoungeRoom(roomIndex) {
                 departmentView.style.backgroundImage = `url(${loungeBackgrounds[roomIndex]})`;
                 if(roomIndex === 0) {
                     loungeNavRight.classList.remove('hidden');
                     loungeNavLeft.classList.add('hidden');
                 } else {
                     loungeNavRight.classList.add('hidden');
                     loungeNavLeft.classList.remove('hidden');
                 }
            }
            loungeNavLeft.addEventListener('click', () => { currentLoungeRoom = 0; setupLoungeRoom(0); });
            loungeNavRight.addEventListener('click', () => { currentLoungeRoom = 1; setupLoungeRoom(1); });
            
            function setupQlSimPlayer() {
                const qlHud = document.getElementById('ql-hud');
                qlHud.innerHTML = `
                    <p>${playlist[currentTrackIndex].title.toUpperCase()}</p>
                    <div id="ql-controls">
                       <button>⏮</button>
                       <button>${isPlaying ? '⏸' : '▶'}</button>
                       <button>⏭</button>
                    </div>
                `;
                 // Add event listeners for QL controls here
            }

            function setupRaceSelect() {
                albumSelectView.classList.remove('hidden');
                trackSelectView.classList.add('hidden');
            }

            albumChoices.forEach(choice => {
                choice.addEventListener('click', () => {
                    const albumKey = choice.dataset.album;
                    currentAlbumTracks = albums[albumKey].tracks;
                    albumSelectView.classList.add('hidden');
                    trackSelectView.classList.remove('hidden');
                    populateTrackList();
                    updateTrackDetails(0);
                });
            });

            function populateTrackList() {
                trackListEl.innerHTML = '';
                currentAlbumTracks.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = 'track-item';
                    item.textContent = track.title;
                    item.dataset.index = index;
                    if (index === 0) item.classList.add('selected');
                    
                    item.addEventListener('click', () => {
                        currentTrackSelection = index;
                        updateTrackDetails(index);
                        document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                    trackListEl.appendChild(item);
                });
            }

            function updateTrackDetails(index) {
                const track = currentAlbumTracks[index];
                trackDetailImage.style.backgroundImage = `url(assets/tracks/placeholder_track_art.png)`; // Placeholder for now
                trackDetailTitle.textContent = track.title.toUpperCase();
                trackDetailLore.textContent = track.lore;
            }

            // Hacking Console Logic
            accessTerminalButton.addEventListener('click', () => hackingConsoleContainer.classList.remove('hidden'));
            closeConsoleBtn.addEventListener('click', () => hackingConsoleContainer.classList.add('hidden'));

            consoleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const command = consoleInput.value.trim().toUpperCase();
                    typeToConsole(`> ${consoleInput.value}`);
                    consoleInput.value = '';
                    processCommand(command);
                }
            });

            function typeToConsole(text, isResponse = false) {
                const p = document.createElement('p');
                if (isResponse) p.style.color = "#A98F64";
                consoleOutput.appendChild(p);
                let i = 0;
                const interval = setInterval(() => {
                    p.textContent += text[i];
                    i++;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    if (i === text.length) clearInterval(interval);
                }, 20);
            }

            function processCommand(command) {
                 setTimeout(() => {
                    if (command === 'LV-GTS-MUSH') {
                        typeToConsole('ACCESSING ARCHIVE LV-GTS-MUSH...', true);
                        setTimeout(() => typeToConsole('DECRYPTING PAYLOAD...', true), 500);
                        setTimeout(() => typeToConsole('DOWNLOAD COMPLETE. LINK: [placeholder_link]', true), 1500);
                    } else if (command === 'REDLININ-PROTO-01') {
                        typeToConsole('ACCESS GRANTED. DISPLAYING PROTOCOL 01...', true);
                         setTimeout(() => typeToConsole('LORE: The REDLININ\' program was initiated to push the boundaries of sonic and automotive fusion...', true), 500);
                    } else {
                        typeToConsole('ERROR: COMMAND NOT RECOGNIZED.', true);
                    }
                 }, 300);
            }

            // News Ticker
            function populateNewsTicker() {
                const ticker = document.getElementById('news-ticker');
                const shuffledHeadlines = [...headlines].sort(() => 0.5 - Math.random());
                let tickerContent = '';
                shuffledHeadlines.forEach(headline => {
                    tickerContent += `<p>${headline}</p>`;
                });
                ticker.innerHTML = tickerContent.repeat(2);
            }


            // MP3 Player & Visualizer Logic
            function setupAudio() {
                gainNode = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 128; 
                gainNode.connect(audioContext.destination);
                analyser.connect(gainNode);
                applySettings(); // Set initial volume
                drawVisualizer(); 
            }

            function drawVisualizer() {
                requestAnimationFrame(drawVisualizer);
                if (!analyser || !isPlaying) {
                    visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                    return;
                }
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
                visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                const barWidth = (visualizerCanvas.width / bufferLength) * 2;
                let barHeight, x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 4; 
                    visualizerCtx.fillStyle = playerData.settings.accentColor;
                    visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 2; 
                }
            }

            function shufflePlaylist() {
                for (let i = playlist.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
                }
            }

            async function loadTrack(index, autoplay = false) {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                if (audioSource) try { audioSource.stop(); } catch (e) {}
                isPlaying = false;
                startOffset = 0;
                audioBuffer = null; 
                playPauseBtn.textContent = '▶';
                trackDisplay.textContent = 'LOADING...';
                
                const trackFile = `assets/music/${playlist[index].file}`;
                try {
                    const response = await fetch(trackFile);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    audioBuffer = decodedBuffer;
                    trackDisplay.textContent = playlist[index].title.toUpperCase();
                    // Check for scrolling text
                    trackDisplay.classList.remove('scroll-text');
                    setTimeout(() => { // Timeout to allow browser to render and get correct width
                        if (trackDisplay.scrollWidth > trackDisplayContainer.clientWidth) {
                            trackDisplay.classList.add('scroll-text');
                        }
                    }, 50);

                    seekSlider.max = audioBuffer.duration;
                    seekSlider.value = 0;
                    if (autoplay) playTrack();
                } catch (e) {
                    console.error('Error loading audio:', e);
                    trackDisplay.textContent = 'ERROR LOADING TRACK';
                }
            }

            function playTrack() {
                if (!audioBuffer || isPlaying) return;
                
                audioSource = audioContext.createBufferSource();
                audioSource.buffer = audioBuffer;
                audioSource.connect(analyser); 
                audioStartTime = audioContext.currentTime - startOffset;
                audioSource.start(0, startOffset);
                isPlaying = true;
                playPauseBtn.textContent = '⏸';
                
                updateLoop();
                
                audioSource.onended = () => {
                    if (isPlaying && (audioContext.currentTime - audioStartTime) >= audioBuffer.duration - 0.1) {
                        playNext();
                    }
                };
            }

            function pauseTrack() {
                if (!isPlaying) return;
                cancelAnimationFrame(animationFrameId);
                startOffset = audioContext.currentTime - audioStartTime;
                try { audioSource.stop(); } catch (e) {}
                isPlaying = false;
                playPauseBtn.textContent = '▶';
            }

            function updateLoop() {
                if (isPlaying && audioBuffer) {
                    const elapsedTime = audioContext.currentTime - audioStartTime;
                    seekSlider.value = elapsedTime;
                    const duration = Math.floor(audioBuffer.duration);
                    timeDisplay.textContent = `${formatTime(elapsedTime)} / ${formatTime(duration)}`;
                    animationFrameId = requestAnimationFrame(updateLoop);
                }
            }
            
            function playNext() {
                currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                if(currentTrackIndex === 0) shufflePlaylist();
                loadTrack(currentTrackIndex, true);
            }

            function playPrev() {
                currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
                loadTrack(currentTrackIndex, true);
            }

            playPauseBtn.addEventListener('click', () => {
                if (isPlaying) pauseTrack(); else playTrack();
            });

            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);

            volumeSlider.addEventListener('input', e => {
                 if (gainNode) gainNode.gain.value = e.target.value / 100;
            });

            seekSlider.addEventListener('input', () => {
                if (!audioBuffer) return;
                cancelAnimationFrame(animationFrameId);
                startOffset = parseFloat(seekSlider.value);
                if (isPlaying) playTrack();
                else updateLoop();
            });
            
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${minutes}:${secs}`;
            }

            // Draggable MP3 Player
            let isDragging = false, offsetX, offsetY;
            mp3Player.querySelector('#mp3-header').addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - mp3Player.offsetLeft;
                offsetY = e.clientY - mp3Player.offsetTop;
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    mp3Player.style.left = (e.clientX - offsetX) + 'px';
                    mp3Player.style.top = (e.clientY - offsetY) + 'px';
                }
            });
            document.addEventListener('mouseup', () => { isDragging = false; });

            // Menu Navigation
            function updateMenuSelection() {
                playSound('C4');
                document.querySelectorAll('.menu-option').forEach((el, index) => {
                    el.classList.toggle('selected', index === currentMenuSelection);
                });
            }
            
            function handleUserInteraction() {
                if(userInteracted) return Promise.resolve();
                userInteracted = true;

                return new Promise((resolve) => {
                    const primeAndResolve = () => {
                        allSounds.forEach(sound => {
                            sound.load(); 
                        });
                        
                        setupAudio();
                        setupSounds();
                        shufflePlaylist();
                        loadTrack(currentTrackIndex, false);
                        isMusicInitialized = true;
                        
                        resolve();
                    };

                    if (audioContext.state === 'suspended') {
                         audioContext.resume().then(primeAndResolve);
                    } else {
                        primeAndResolve();
                    }
                });
            }

            const handleMenuClick = (isEnterKey = false) => {
                const action = () => {
                     if (currentState === 'main-menu' || currentState === 'title') {
                        const target = menuOptions[currentMenuSelection] === 'new-game' ? 'hq-lobby' : 'department-settings';
                        transition(target);
                    }
                };
                if (!userInteracted) {
                    handleUserInteraction().then(action);
                } else {
                    action();
                }
            };
            
            const startBootSequence = () => {
                handleUserInteraction().then(() => {
                    initialScreen.classList.add('hidden');
                    bootSeq.classList.remove('hidden');
                    currentState = 'boot';
                    bootupAudio.volume = 1.0; 
                    bootupAudio.play();
                    
                    setTimeout(() => {
                        lvScreen.classList.add('hidden');
                        pubScreen.classList.remove('hidden');
                    }, 3000);

                    setTimeout(() => {
                        pubScreen.classList.add('hidden');
                        bootSeq.classList.add('hidden');
                        
                        transition('title-screen');
                        
                        setTimeout(() => {
                            racecarSfxAudio.play();
                            redlininLogo.style.animation = 'slam-in 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        }, 500);
                        
                    }, 6000);
                });
            };

            initialPressStart.addEventListener('click', startBootSequence);

            pressStart.addEventListener('click', () => {
                if(currentState === 'title') {
                    transition('main-menu');
                }
            });

            menuOptionNewGame.addEventListener('mouseover', () => { if(currentMenuSelection !== 0) { currentMenuSelection = 0; updateMenuSelection();} });
            menuOptionSettings.addEventListener('mouseover', () => { if(currentMenuSelection !== 1) { currentMenuSelection = 1; updateMenuSelection();} });
            menuOptionNewGame.addEventListener('click', () => handleMenuClick());
            menuOptionSettings.addEventListener('click', () => handleMenuClick());
            
            window.addEventListener('keydown', (e) => {
                if (currentState === 'initial' && e.key === 'Enter') {
                    startBootSequence();
                } else if (currentState === 'title' && e.key === 'Enter') {
                    transition('main-menu');
                } else if (currentState === 'main-menu') {
                    if (e.key === 'ArrowUp' || e.key === 'w') {
                        currentMenuSelection = (currentMenuSelection - 1 + menuOptions.length) % menuOptions.length;
                        updateMenuSelection();
                    } else if (e.key === 'ArrowDown' || e.key === 's') {
                        currentMenuSelection = (currentMenuSelection + 1) % menuOptions.length;
                        updateMenuSelection();
                    } else if (e.key === 'Enter') {
                        handleMenuClick(true);
                    }
                }
            });

            // Clock
            function updateClock() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                hudClock.textContent = `${hours}:${minutes}`;
            }

            // --- Event Listeners for Navigation ---
            document.querySelectorAll('.hotspot').forEach(hotspot => {
                hotspot.addEventListener('mouseover', () => playSound('F5'));
                hotspot.addEventListener('click', () => {
                    const target = hotspot.dataset.target;
                    if (hotspot.classList.contains('locked')) {
                        playSound('C3', '4n');
                        showNotification("DEPARTMENT LOCKED // ACCESS DENIED");
                        return;
                    }
                    if (target) {
                        transition(`department-${target}`);
                    }
                });
            });

            backButton.addEventListener('click', () => {
                if (currentState === 'department' && !driverDataScreen.classList.contains('hidden')) {
                    transition('main-menu');
                } else {
                    transition('hq-lobby', true); // Pass true to indicate it's a return trip
                }
            });

            // --- Initial Setup ---
            loadPlayerData();
            populateNewsTicker();
            setInterval(updateClock, 1000);
            updateClock();
            
            hudBar.classList.add('hidden');
        });
    </script>
</body>

</html>

